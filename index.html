<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Estudio Bíblico con IA y Firebase</title>
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Google Fonts - Roboto para mejorar la estética de la imagen resumen -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Google Fonts - Para fuente cursiva, opcional, si no, usa el genérico 'cursive' -->
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase modules globally for the BibleApp class
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            where,
            addDoc,
            getDocs
        };
    </script>

    <style>
        :root {
            --primary-color: #005a9c; /* Un azul más sobrio */
            --secondary-color: #6c757d;
            --light-gray: #f8f9fa;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --ai-feature-color: #6f42c1; /* Púrpura para funciones de IA */
        }
        body { font-family: -apple-system, BlinkMacMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #e9ecef; color: #333; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 2rem 1rem; }
        .container { background-color: white; padding: 2rem; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 100%; max-width: 900px; }
        h1, h2, h3, h4, h5 { color: #2c3e50; }
        h1 { text-align: center; margin-bottom: 1.5rem; }
        h2 { border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; margin-top: 2rem; }
        
        /* Sistema de Pestañas */
        .tabs { display: flex; border-bottom: 2px solid var(--border-color); margin-bottom: 1.5rem; flex-wrap: wrap; }
        .tab-link { padding: 1rem 1.5rem; cursor: pointer; background: none; border: none; font-size: 1rem; color: var(--secondary-color); position: relative; }
        .tab-link.active { color: var(--primary-color); font-weight: bold; }
        .tab-link.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .module { background-color: var(--light-gray); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; align-items: flex-end; margin-bottom: 1rem; }
        select, button, textarea, input[type="text"] { padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; background-color: #fff; width: 100%; box-sizing: border-box; }
        select:disabled { background-color: #e9ecef; cursor: not-allowed; opacity: 0.7; }
        
        .btn { border-radius: 8px; font-weight: bold; cursor: pointer; transition: opacity 0.2s; border: none; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-ai { background-color: var(--ai-feature-color); color: white; }
        .btn-sm { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
        
        #passage-list, #saved-studies-list { list-style: none; padding: 0; margin-top: 1rem; }
        #passage-list li, #saved-studies-list li { background: #e9ecef; padding: 0.75rem 1rem; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        #passage-list li:hover, #saved-studies-list li:hover { background: #dce1e6; }
        .remove-btn { background: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem; flex-shrink: 0; margin-left: 0.5rem;}
        .export-history-btn { background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; cursor: pointer; font-size: 0.8rem; flex-shrink: 0; margin-left: 0.5rem;}
        .view-history-btn {
            background-color: var(--ai-feature-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            font-size: 0.8rem;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        
        .results-area { margin-top: 1rem; }
        .loading, .error { text-align: center; padding: 1.5rem; border-radius: 8px; margin-top: 1rem; }
        .loading { color: #555; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .analysis-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1.5rem; overflow: hidden; }
        .analysis-card-header { background-color: #343a40; color: white; padding: 1rem 1.5rem; margin: 0; display: flex; justify-content: space-between; align-items: center; }
        .analysis-card-header h3 { color: white; /* FIX: Ensure title is visible on dark header */ }
        .card-buttons button { font-size: 0.8rem; padding: 0.4rem 0.8rem; width: auto; margin-left: 0.5rem; background-color: var(--secondary-color); color:white; border:none; cursor:pointer;}
        .card-buttons button:hover { background-color: #5a6268; }

        /* New styles for copy button within sections */
        .section-title { 
            margin-top: 1.5rem; 
            margin-bottom: 0.75rem; 
            color: #495057; 
            border-bottom: 2px solid var(--border-color); 
            padding-bottom: 0.5rem;
            display: flex; /* Enable flex for alignment */
            justify-content: space-between; /* Push copy button to the right */
            align-items: center; /* Vertically align items */
        }
        .section-title .copy-btn {
            font-size: 0.75rem; /* Smaller for internal sections */
            padding: 0.3rem 0.6rem;
            margin-left: 1rem; /* Space from title */
            background-color: var(--secondary-color); 
            color: white; 
            border: none; 
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .section-title .copy-btn:hover {
            background-color: #5a6268;
        }
        /* Style for copy button on main cards (QA, Dictionary, Devotional) */
        .analysis-card .card-header .copy-btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .analysis-card .card-header .copy-btn:hover {
            background-color: #5a6268;
        }

        .card-content { padding: 1.5rem; }
        .card-content p { margin: 0 0 1rem 0; line-height: 1.6; }
        .card-content ul { padding-left: 20px; }
        .card-content h5 { margin-top: 1rem; margin-bottom: 0.5rem; color: var(--primary-color); font-size: 1.1rem; }
        blockquote { border-left: 5px solid var(--primary-color); padding-left: 1rem; margin: 0 0 1rem 0; font-style: italic; white-space: pre-wrap; }
        blockquote p { margin-bottom: 0.5rem; }
        .devotional-image { width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem; }
        
        .styled-table { width: 100%; border-collapse: collapse; margin-top: 1rem; table-layout: fixed; }
        .styled-table th, .styled-table td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border-color); word-wrap: break-word; vertical-align: top; }
        .styled-table th { background-color: var(--light-gray); }
        .hebrew-word { font-size: 1.2rem; }
        .hebrew-word a { text-decoration: none; color: var(--primary-color); font-weight: bold; }
        .hebrew-word a:hover { text-decoration: underline; }
        .cross-ref-list { list-style-type: none; padding-left: 0; }
        .cross-ref-list a { text-decoration: none; color: var(--primary-color); font-weight: 500;}
        .cross-ref-list a:hover { text-decoration: underline; }
        textarea#global-personal-notes, #qa-input, #dictionary-input, #thematic-input, #question-generator-input, #concordance-input, #teaching-theme-input { width: 100%; min-height: 80px; margin-top: 0.5rem; padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }
        
        /* MODIFIED: Global Notes Section Styles */
        #global-study-controls {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border: 2px dashed var(--primary-color);
            border-radius: 8px;
            background-color: var(--light-gray);
        }
        #global-study-controls h3 {
             margin-top: 0;
             border-bottom: 2px solid var(--border-color);
             padding-bottom: 0.5rem;
        }
        #global-study-controls textarea {
            min-height: 150px;
        }
        #global-study-controls .button-group {
            margin-top: 1rem;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #global-study-controls .button-group button {
            width: auto;
            padding: 0.8rem 1.5rem;
            flex-grow: 1;
        }

        /* ================================================= */
        /* ESTILOS MEJORADOS PARA POP-UPS (MODALES)        */
        /* ================================================= */
        @keyframes modal-pop {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(44, 62, 80, 0.6); /* Un fondo más oscuro y azulado */
            display: none; /* Controlado por JS */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px); /* Efecto de desenfoque moderno */
            -webkit-backdrop-filter: blur(5px);
            opacity: 0; /* Estado inicial para la transición */
            transition: opacity 0.3s ease-in-out;
        }

        /* Cuando el modal se muestra (JS cambia display), activamos la opacidad */
        .modal-overlay[style*="display: flex"] {
            opacity: 1;
        }

        .modal-content {
            background: white;
            padding: 0; /* Quitamos el padding para controlar las secciones internas */
            border-radius: 12px; /* Bordes más redondeados */
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow: hidden; /* Clave para que el border-radius afecte a los hijos */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), 0 6px 10px rgba(0, 0, 0, 0.15);
            display: flex; /* Usamos flexbox para la estructura interna */
            flex-direction: column;
            animation: modal-pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem; /* Espaciado generoso */
            border-bottom: 1px solid var(--border-color);
            background-color: var(--light-gray); /* Un color de fondo sutil */
        }

        .modal-header h4 {
            margin: 0;
            font-size: 1.25rem; /* Título más grande */
            color: var(--primary-color);
        }

        .modal-close-btn {
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--secondary-color);
            padding: 0.5rem;
            line-height: 1;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .modal-close-btn:hover {
            background-color: #e9ecef;
            color: var(--danger-color);
        }

        /* Nuevo estilo para el cuerpo del modal */
        .modal-body {
            padding: 1.5rem;
            overflow-y: auto; /* El scroll solo en el cuerpo */
            flex-grow: 1; /* Permite que el cuerpo ocupe el espacio disponible */
        }
        .modal-body p {
            line-height: 1.7; /* Mejor legibilidad */
            margin-bottom: 1rem;
        }
        .modal-body p:last-child {
            margin-bottom: 0;
        }


        .modal-nav {
            display: flex;
            justify-content: space-between; /* MODIFIED for view modal */
            align-items: center;
            gap: 0.75rem; /* Espacio entre botones */
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-gray);
        }

        /* Específico para el modal de referencias cruzadas que tiene nav central */
        #cross-ref-modal .modal-nav {
            justify-content: space-between;
        }

        .modal-nav button {
            width: auto; /* Ancho automático para botones de confirmación */
            padding: 0.6rem 1.2rem;
        }

        /* Mantiene el ancho dividido para Anterior/Siguiente */
        #cross-ref-modal .modal-nav button {
            width: 48%; 
        }

        /* Style for horizontal verse display */
        .verse-horizontal-list {
            display: block; /* Ensures it takes full width for wrapping */
            white-space: normal; /* Allow text to wrap naturally */
        }
        .verse-horizontal-list .verse-item {
            display: inline-block; /* Changed to inline-block for better spacing */
            margin-right: 0.7em; /* Space between verses */
            margin-bottom: 0.5em; /* Space between lines if they wrap */
        }
        .verse-horizontal-list .verse-item b {
            font-weight: bold;
            color: var(--primary-color); /* Make reference stand out */
        }

        /* Grid for verse selection checkboxes */
        #verse-checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(30px, 1fr)); /* Adjust minmax(30px, 1fr) for desired checkbox size */
            gap: 5px; /* Space between checkboxes */
            padding: 1rem 0;
            max-height: 250px; /* Limit height and make it scrollable if too many verses */
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #fff;
            padding: 10px;
        }
        #verse-checkbox-grid.disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        .verse-checkbox-item {
            display: flex;
            align-items: center;
            justify-content: center; /* Center content horizontally */
            flex-direction: column; /* Stack checkbox and label vertically */
            padding: 2px; /* Small padding inside each item */
        }
        .verse-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-bottom: 2px; /* Space between checkbox and number */
        }
        .verse-checkbox-item label {
            font-size: 0.8rem; /* Smaller font for verse numbers */
            color: #555;
            text-align: center;
        }

        .devotional-verse-link {
            color: var(--primary-color);
            text-decoration: underline;
            cursor: pointer;
            font-weight: bold;
        }

        /* Reading Plan Styles */
        #reading-plan-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            max-height: 60vh;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .reading-day-card {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-left: 5px solid var(--secondary-color);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .reading-day-card.completed {
            background-color: #e2f0e6;
            border-left-color: var(--success-color);
        }
        .reading-day-card.completed h5 {
            text-decoration: line-through;
            color: var(--secondary-color);
        }
        .reading-day-card h5 {
            margin-top: 0;
            margin-bottom: 0.5rem;
        }
        .reading-day-card .reading-passage-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }
        .reading-day-card .reading-passage-link:hover {
            text-decoration: underline;
        }
        .reading-day-card .card-footer {
            margin-top: auto; /* Pushes footer to the bottom */
            padding-top: 0.75rem;
        }
        .reading-day-card .btn-toggle-complete {
            width: 100%;
            font-size: 0.8rem;
            padding: 0.6rem 0.8rem;
            background-color: var(--secondary-color);
            color: white;
        }
        .reading-day-card.completed .btn-toggle-complete {
            background-color: var(--success-color);
        }

        /* Timeline Styles */
        .timeline {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
        }
        .timeline::after {
            content: '';
            position: absolute;
            width: 6px;
            background-color: var(--primary-color);
            top: 0;
            bottom: 0;
            left: 50%;
            margin-left: -3px;
        }
        .timeline-container {
            padding: 10px 40px;
            position: relative;
            background-color: inherit;
            width: 50%;
        }
        .timeline-container.left { left: 0; }
        .timeline-container.right { left: 50%; }
        .timeline-container::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            right: -17px;
            background-color: white;
            border: 4px solid var(--ai-feature-color);
            top: 15px;
            border-radius: 50%;
            z-index: 1;
        }
        .timeline-container.right::after { left: -16px; }
        .timeline-content {
            padding: 20px 30px;
            background-color: white;
            position: relative;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        .timeline-content h6 {
            margin-top: 0;
            font-weight: bold;
            color: var(--primary-color);
        }
        .timeline-content p {
            font-size: 0.9rem;
            margin-bottom: 0;
        }
        .timeline-content small {
            font-style: italic;
            color: var(--secondary-color);
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Herramienta de Estudio Bíblico</h1>
        
        <div class="tabs">
            <button class="tab-link active" data-tab="tab-1"><i class="fas fa-book-open"></i> Análisis de Pasajes</button>
            <button class="tab-link" data-tab="tab-2"><i class="fas fa-tools"></i> Herramientas de Estudio</button>
            <button class="tab-link" data-tab="tab-4"><i class="fas fa-calendar-alt"></i> Planes de Lectura</button>
            <button class="tab-link" data-tab="tab-3"><i class="fas fa-user-edit"></i> Personal e Interactivo</button>
        </div>

        <div id="tab-1" class="tab-content active">
            <div class="module">
                <h2>Paso 1: Añadir Pasajes</h2>
                <div class="passage-adder">
                    <div class="controls">
                        <select id="book" name="book" required><option value="">Seleccione un libro</option></select>
                        <select id="chapter" name="chapter" required disabled><option value="">Capítulo</option></select>
                    </div>
                    <div class="checkbox-container">
                        <input type="checkbox" id="select-all-verses"><label for="select-all-verses">Seleccionar todo el capítulo</label>
                    </div>
                    <div id="verse-selection-container" class="verse-selector-container disabled">
                        <div id="verse-checkbox-grid" class="verse-checkbox-grid"></div>
                    </div>
                    <button id="add-passage-btn" class="btn btn-success" type="button">Añadir Pasaje(s)</button>
                </div>
            </div>
            <div class="module">
                <h2>Paso 2: Opciones y Análisis</h2>
                <p>Selecciona las versiones a comparar y los pasajes añadidos antes de analizar.</p>
                <div class="checkbox-container">
                    <input type="checkbox" id="version-kjv" value="King James (Español)" checked disabled><label for="version-kjv">King James (Español)</label>
                    <input type="checkbox" id="version-rvr" value="Reina Valera 1960"><label for="version-rvr">Reina Valera 1960</label>
                    <input type="checkbox" id="version-nvi" value="Nueva Versión Internacional"><label for="version-nvi">Nueva Versión Internacional</label>
                    <input type="checkbox" id="version-jbs" value="Biblia del Jubileo"><label for="version-jbs">Biblia del Jubileo</label>
                </div>
                
                <div style="margin-top: 1rem; margin-bottom: 1rem;">
                    <label for="analysis-theme-input" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Tema Específico para Análisis Exegético (Opcional):</label>
                    <input type="text" id="analysis-theme-input" placeholder="Ej: El amor, la soberanía de Dios, el perdón...">
                </div>

                <h4>Pasajes a Estudiar:</h4>
                <ul id="passage-list"></ul>
                <button id="analyze-passages-btn" class="btn btn-primary" type="button" disabled>Analizar Pasajes con IA</button>
                
                <!-- MODIFIED: Notes module moved here -->
                <div id="global-study-controls">
                    <h3><i class="fas fa-pencil-alt"></i> Notas Personales del Estudio</h3>
                    <p style="font-size: 0.9rem; color: var(--secondary-color); margin-top: -0.5rem; margin-bottom: 1rem;">
                        Tus notas se guardan automáticamente en este dispositivo a medida que escribes.
                    </p>
                    <textarea id="global-personal-notes" placeholder="Escribe aquí tus notas, reflexiones y conclusiones generales para todos los pasajes estudiados..."></textarea>
                    <div class="button-group">
                        <button id="save-session-study-btn" class="btn btn-success" disabled>Guardar Estudio</button>
                        <button id="export-session-study-btn" class="btn btn-primary" disabled>Exportar Estudio a PDF</button>
                        <button id="copy-notes-btn" class="btn btn-secondary" type="button">Copiar Notas</button>
                    </div>
                </div>

                <div id="results-container" class="results-area"></div>
            </div>

            <!-- ================================================================= -->
            <!-- ======================= NEW TEACHING SECTION ====================== -->
            <!-- ================================================================= -->
            <div id="teaching-study-section" class="module">
                <h2>Estudio Profundo para Enseñar</h2>
                <p>Usa los pasajes añadidos arriba y un tema central para generar un estudio detallado, ideal para enseñar a un grupo. Incluirá ejemplos, una historia bíblica y más.</p>
                <div style="margin-top: 1rem; margin-bottom: 1rem;">
                    <label for="teaching-theme-input" style="display: block; margin-bottom: 0.5rem; font-weight: bold;">Tema Central para la Enseñanza:</label>
                    <input type="text" id="teaching-theme-input" placeholder="Ej: La fe que mueve montañas, El propósito del sufrimiento...">
                </div>
                <button id="generate-teaching-study-btn" class="btn btn-primary" type="button"><i class="fas fa-chalkboard-teacher"></i> Generar Estudio para Enseñar</button>
                <div id="teaching-results-container" class="results-area"></div>
            </div>
            <!-- ================================================================= -->
            <!-- ===================== END OF NEW TEACHING SECTION ================= -->
            <!-- ================================================================= -->

        </div>

        <div id="tab-2" class="tab-content">
            <div id="dictionary-section" class="module">
                <h2>Diccionario Teológico por IA</h2>
                <p>Escribe una palabra o concepto teológico para obtener una definición expositiva.</p>
                <input type="text" id="dictionary-input" placeholder="Ej: Gracia, Redención, Pacto...">
                <button id="define-word-btn" class="btn btn-secondary" type="button">Definir Palabra</button>
                <div id="dictionary-results-container" class="results-area"></div>
            </div>
            <div id="thematic-analysis-section" class="module">
                <h2>Análisis Temático Transversal</h2>
                <p>Introduce un tema para ver cómo se desarrolla a lo largo de la Biblia.</p>
                <input type="text" id="thematic-input" placeholder="Ej: El Reino de Dios, El Pacto...">
                <button id="analyze-theme-btn" class="btn btn-secondary" type="button">Analizar Tema</button>
                <div id="thematic-results-container" class="results-area"></div>
            </div>

            <div id="question-generator-section" class="module">
                <h2>Generador de Preguntas de Estudio</h2>
                <p>Introduce un pasaje bíblico (ej. Juan 3:16-18) para generar preguntas y respuestas para tu estudio personal o grupal.</p>
                <input type="text" id="question-generator-input" placeholder="Ej: Juan 3:16-18, Salmos 23">
                <button id="generate-questions-btn" class="btn btn-secondary" type="button">Generar Preguntas y Respuestas</button>
                <div id="question-generator-results-container" class="results-area"></div>
            </div>

            <div id="concordance-section" class="module">
                <h2>Concordancia Rápida</h2>
                <p>Busca una palabra para encontrar versículos donde aparece en la Biblia.</p>
                <input type="text" id="concordance-input" placeholder="Ej: Amor, Fe, Esperanza">
                <button id="search-concordance-btn" class="btn btn-secondary" type="button">Buscar Palabra</button>
                <div id="concordance-results-container" class="results-area"></div>
            </div>

        </div>

        <div id="tab-4" class="tab-content">
            <div class="module">
                <h2>Planes de Lectura Bíblica</h2>
                <div class="controls">
                    <select id="reading-plan-select">
                        <option value="">Seleccione un Plan</option>
                    </select>
                </div>
                <div id="reading-plan-details">
                    <p>Seleccione un plan de lectura para comenzar.</p>
                </div>
            </div>
        </div>

        <div id="tab-3" class="tab-content">
            <div id="devotional-section" class="module">
                <h2>Devocional Diario</h2>
                <p>Obtén un pasaje, reflexión y oración para un estudio de 30 minutos.</p>
                <button id="generate-devotional-btn" class="btn btn-secondary" type="button">Generar Devocional de Hoy</button>
                <button id="force-generate-devotional-btn" class="btn btn-secondary" type="button" style="margin-top: 10px;">Generar Nuevos Devocionales (Ignorar Historial)</button>
                <div id="devotional-overall-status" class="results-area"></div>
                <div id="devotional-morning-container"></div>
                <div id="devotional-night-container" style="margin-top: 2rem;"></div>
            </div>
            <div id="qa-section" class="module">
                <h2>Pregúntale a la IA</h2>
                <p>Haz cualquier pregunta sobre teología, historia bíblica, o el significado de algún concepto.</p>
                <textarea id="qa-input" placeholder="Escribe tu pregunta aquí..."></textarea>
                <button id="ask-ai-btn" class="btn btn-secondary" type="button">Enviar Pregunta</button>
                <div id="qa-results-container" class="results-area"></div>
            </div>
            <div id="history-section" class="module">
                <h2>Historial de Estudios Guardados</h2>
                <input type="text" id="history-filter" placeholder="Filtrar estudios por título o etiqueta...">
                <ul id="saved-studies-list"></ul>
                <p id="user-id-display" style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 1rem;"></p>
            </div>
        </div>
    </div>
    
    <div id="cross-ref-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="modal-title"></h4><button id="modal-close" class="modal-close-btn">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"><p class="loading">Cargando versículo...</p></div>
            <div class="modal-nav">
                <button id="modal-prev-btn" class="btn btn-secondary">Anterior</button>
                <button id="modal-next-btn" class="btn btn-primary">Siguiente</button>
            </div>
        </div>
    </div>

    <!-- NEW: Generic Modal for AI Features (Illustrations, Dialogues, etc.) -->
    <div id="generic-content-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="generic-modal-title"></h4><button id="generic-modal-close" class="modal-close-btn">&times;</button>
            </div>
            <div id="generic-modal-body" class="modal-body"><p class="loading">✨ La IA está creando... ✨</p></div>
            <div class="modal-nav">
                <div id="generic-modal-extra-buttons" style="display: flex; gap: 0.75rem;"></div>
                <button id="generic-modal-ok-btn" class="btn btn-primary">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        class BibleApp {
            constructor() {
                this.apiKey = ""; // Canvas will provide this.
                this.BIBLE_BOOKS = [
                    { "name": "Génesis", "abbrev": "gn", "chapters": [31, 25, 24, 26, 32, 22, 24, 22, 29, 32, 32, 20, 18, 24, 21, 16, 27, 33, 38, 18, 34, 24, 20, 67, 34, 35, 46, 22, 35, 43, 55, 32, 20, 31, 29, 43, 36, 30, 23, 23, 57, 38, 34, 34, 28, 34, 31, 22, 33, 26] },
                    { "name": "Éxodo", "abbrev": "ex", "chapters": [22, 25, 22, 31, 23, 30, 25, 32, 35, 29, 10, 51, 22, 31, 27, 36, 16, 27, 25, 26, 36, 31, 33, 18, 40, 37, 21, 43, 46, 38, 18, 35, 23, 35, 35, 38, 29, 31, 43, 38] },
                    { "name": "Levítico", "abbrev": "lv", "chapters": [17, 16, 17, 35, 19, 30, 38, 36, 24, 20, 47, 8, 59, 57, 33, 34, 16, 30, 37, 27, 24, 33, 44, 23, 55, 46, 34] },
                    { "name": "Números", "abbrev": "nm", "chapters": [54, 34, 51, 49, 31, 27, 89, 26, 23, 36, 35, 16, 33, 45, 41, 50, 13, 32, 22, 29, 35, 41, 30, 25, 18, 65, 23, 31, 40, 16, 33, 42, 56, 29, 34, 13] },
                    { "name": "Deuteronomio", "abbrev": "dt", "chapters": [46, 37, 29, 49, 33, 25, 26, 20, 29, 22, 32, 32, 18, 29, 23, 22, 20, 22, 21, 20, 23, 30, 25, 22, 19, 19, 26, 68, 29, 20, 30, 52, 29, 12] },
                    { "name": "Josué", "abbrev": "jos", "chapters": [18, 24, 17, 24, 15, 27, 26, 35, 27, 43, 23, 24, 33, 15, 63, 10, 18, 28, 51, 9, 45, 34, 16, 33] },
                    { "name": "Jueces", "abbrev": "jdg", "chapters": [36, 23, 31, 24, 31, 40, 25, 35, 57, 18, 40, 15, 25, 20, 20, 31, 13, 31, 30, 48, 25] },
                    { "name": "Rut", "abbrev": "rt", "chapters": [22, 23, 18, 22] },
                    { "name": "1 Samuel", "abbrev": "1sm", "chapters": [28, 36, 21, 22, 12, 21, 17, 22, 27, 27, 15, 25, 23, 52, 35, 23, 58, 30, 24, 42, 15, 23, 29, 22, 44, 25, 12, 25, 11, 31, 13] },
                    { "name": "2 Samuel", "abbrev": "2sm", "chapters": [27, 32, 39, 12, 25, 23, 29, 18, 13, 19, 27, 31, 39, 31, 37, 23, 29, 33, 43, 26, 22, 51, 39, 25] },
                    { "name": "1 Reyes", "abbrev": "1ki", "chapters": [53, 46, 28, 34, 18, 38, 51, 66, 28, 29, 43, 33, 34, 31, 34, 34, 24, 46, 21, 43, 29, 53] },
                    { "name": "2 Reyes", "abbrev": "2ki", "chapters": [18, 25, 27, 44, 27, 33, 20, 29, 37, 36, 20, 21, 25, 29, 38, 20, 41, 37, 37, 21, 26, 20, 37, 20, 30] },
                    { "name": "1 Crónicas", "abbrev": "1ch", "chapters": [54, 55, 24, 43, 26, 81, 40, 40, 44, 14, 47, 40, 14, 17, 29, 43, 27, 17, 19, 8, 30, 19, 32, 31, 31, 32, 34, 21, 30] },
                    { "name": "2 Crónicas", "abbrev": "2ch", "chapters": [17, 18, 17, 22, 14, 42, 22, 18, 31, 19, 23, 16, 22, 15, 19, 14, 19, 34, 11, 37, 20, 12, 21, 27, 28, 23, 9, 27, 36, 27, 21, 32, 25, 33, 27, 23] },
                    { "name": "Esdras", "abbrev": "ezr", "chapters": [11, 70, 13, 24, 17, 22, 28, 36, 15, 44] },
                    { "name": "Nehemías", "abbrev": "neh", "chapters": [11, 20, 32, 23, 19, 19, 73, 18, 38, 39, 36, 47, 31] },
                    { "name": "Ester", "abbrev": "est", "chapters": [22, 23, 15, 17, 14, 14, 10, 17, 32, 3] },
                    { "name": "Job", "abbrev": "job", "chapters": [22, 13, 26, 21, 27, 30, 21, 22, 35, 22, 20, 25, 28, 22, 35, 22, 16, 21, 29, 29, 34, 30, 17, 25, 6, 14, 23, 28, 25, 31, 40, 22, 33, 37, 16, 33, 24, 41, 30, 24, 34, 17] },
                    { "name": "Salmos", "abbrev": "ps", "chapters": [
                        6, 12, 8, 8, 12, 10, 17, 9, 20, 18, 7, 8, 6, 7, 5, 11, 15, 50, 14, 9, 13, 31, 6, 10, 22, 12, 14, 9, 11, 12, 24, 11, 22, 22, 28, 12, 40, 22, 13, 17, 13, 11, 5, 26, 17, 11, 9, 14, 20, 23, // 1-50
                        19, 11, 7, 9, 24, 14, 12, 12, 18, 14, 9, 13, 12, 11, 14, 20, 8, 36, 37, 6, 24, 20, 28, 23, 11, 13, 21, 72, 13, 20, 17, 8, 19, 13, 14, 17, 7, 19, 53, 17, 16, 16, 5, 23, 11, 13, 12, 9, 9, 5, // 51-100
                        8, 29, 22, 35, 45, 48, 43, 14, 31, 7, 10, 10, 9, 8, 18, 19, 2, 29, 176, 7, 8, 9, 4, 8, 5, 6, 5, 6, 8, 8, 3, 18, 3, 3, 21, 26, 9, 8, 24, 14, 10, 8, 12, 15, 21, 10, 20, 14, 9, 6 // 101-150
                    ] },
                    { "name": "Proverbios", "abbrev": "prv", "chapters": [33, 22, 35, 27, 23, 35, 27, 36, 18, 32, 31, 28, 25, 35, 33, 33, 28, 24, 29, 30, 31, 29, 35, 34, 28, 28, 27, 28, 27, 33, 31] },
                    { "name": "Eclesiastés", "abbrev": "ec", "chapters": [18, 26, 22, 16, 20, 12, 14, 17, 18, 20, 10, 14] },
                    { "name": "Cantares", "abbrev": "sos", "chapters": [17, 17, 11, 16, 16, 13, 13, 14] },
                    { "name": "Isaías", "abbrev": "is", "chapters": [31, 22, 26, 6, 30, 13, 25, 22, 21, 34, 16, 6, 22, 32, 9, 14, 14, 7, 25, 6, 17, 25, 18, 23, 12, 21, 13, 29, 24, 33, 9, 20, 24, 17, 10, 22, 38, 22, 8, 31, 29, 25, 28, 28, 25, 13, 15, 22, 26, 11, 23, 15, 12, 17, 13, 12, 21, 14, 21, 22, 11, 12, 19, 12, 25, 24] },
                    { "name": "Jeremías", "abbrev": "jer", "chapters": [19, 37, 25, 31, 31, 30, 25, 34, 22, 26, 25, 23, 17, 27, 22, 21, 21, 27, 23, 15, 18, 14, 30, 40, 10, 38, 24, 22, 17, 32, 24, 40, 44, 26, 22, 19, 32, 21, 28, 18, 16, 18, 22, 13, 30, 5, 28, 7, 47, 39, 46, 64, 34] },
                    { "name": "Lamentaciones", "abbrev": "lm", "chapters": [22, 22, 66, 22, 22] },
                    { "name": "Ezequiel", "abbrev": "ezk", "chapters": [28, 10, 27, 17, 17, 14, 27, 18, 11, 22, 25, 28, 23, 23, 8, 63, 24, 32, 14, 49, 32, 31, 49, 27, 17, 21, 36, 26, 21, 26, 18, 32, 33, 31, 15, 38, 28, 23, 29, 49, 26, 20, 27, 31, 25, 24, 23, 35] },
                    { "name": "Daniel", "abbrev": "dn", "chapters": [21, 49, 30, 37, 31, 28, 28, 27, 27, 21, 45, 13] },
                    { "name": "Oseas", "abbrev": "hos", "chapters": [11, 23, 5, 19, 15, 11, 16, 14, 17, 15, 12, 14, 16, 9] },
                    { "name": "Joel", "abbrev": "jl", "chapters": [20, 32, 21] },
                    { "name": "Amós", "abbrev": "am", "chapters": [15, 16, 15, 13, 27, 14, 17, 14, 15] },
                    { "name": "Abdías", "abbrev": "ob", "chapters": [21] },
                    { "name": "Jonás", "abbrev": "jon", "chapters": [17, 10, 10, 11] },
                    { "name": "Miqueas", "abbrev": "mic", "chapters": [16, 13, 12, 13, 15, 16, 20] },
                    { "name": "Nahúm", "abbrev": "nah", "chapters": [15, 13, 19] },
                    { "name": "Habacuc", "abbrev": "hab", "chapters": [17, 20, 19] },
                    { "name": "Sofonías", "abbrev": "zep", "chapters": [18, 15, 20] },
                    { "name": "Hageo", "abbrev": "hg", "chapters": [15, 23] },
                    { "name": "Zacarías", "abbrev": "zec", "chapters": [21, 13, 10, 14, 11, 15, 14, 23, 17, 12, 17, 14, 9, 21] },
                    { "name": "Malaquías", "abbrev": "mal", "chapters": [14, 17, 18, 6] },
                    { "name": "Mateo", "abbrev": "mt", "chapters": [25, 23, 17, 25, 48, 34, 29, 34, 38, 42, 30, 50, 58, 36, 39, 28, 27, 35, 30, 34, 46, 46, 39, 51, 46, 75, 66, 20] },
                    { "name": "Marcos", "abbrev": "mk", "chapters": [45, 28, 35, 41, 43, 56, 37, 38, 50, 52, 33, 44, 37, 72, 47, 20] },
                    { "name": "Lucas", "abbrev": "lk", "chapters": [80, 52, 38, 44, 39, 49, 50, 56, 62, 42, 54, 59, 35, 35, 32, 31, 37, 43, 48, 47, 38, 71, 56, 53] },
                    { "name": "Juan", "abbrev": "jhn", "chapters": [51, 25, 36, 54, 47, 71, 53, 59, 41, 42, 57, 50, 38, 31, 27, 33, 26, 40, 42, 31, 25] },
                    { "name": "Hechos", "abbrev": "act", "chapters": [26, 47, 26, 37, 42, 15, 60, 40, 43, 48, 30, 25, 52, 28, 41, 40, 34, 28, 41, 38, 40, 30, 35, 27, 27, 32, 44, 31] },
                    { "name": "Romanos", "abbrev": "rm", "chapters": [32, 29, 31, 25, 21, 23, 25, 39, 33, 21, 36, 21, 14, 23, 33, 27] },
                    { "name": "1 Corintios", "abbrev": "1co", "chapters": [31, 16, 23, 21, 13, 20, 40, 13, 27, 33, 34, 31, 13, 40, 58, 24] },
                    { "name": "2 Corintios", "abbrev": "2co", "chapters": [24, 17, 18, 18, 21, 18, 16, 24, 15, 18, 33, 21, 14] },
                    { "name": "Gálatas", "abbrev": "gal", "chapters": [24, 21, 29, 31, 26, 18] },
                    { "name": "Efesios", "abbrev": "eph", "chapters": [23, 22, 21, 32, 33, 24] },
                    { "name": "Filipenses", "abbrev": "php", "chapters": [30, 30, 21, 23] },
                    { "name": "Colosenses", "abbrev": "col", "chapters": [29, 23, 25, 18] },
                    { "name": "1 Tesalonicenses", "abbrev": "1th", "chapters": [10, 20, 13, 18, 28] },
                    { "name": "2 Tesalonicenses", "abbrev": "2th", "chapters": [12, 17, 18] },
                    { "name": "1 Timoteo", "abbrev": "1ti", "chapters": [20, 16, 16, 16, 25, 21] },
                    { "name": "2 Timoteo", "abbrev": "2ti", "chapters": [18, 26, 17, 22] },
                    { "name": "Tito", "abbrev": "tit", "chapters": [16, 15, 15] },
                    { "name": "Filemón", "abbrev": "phm", "chapters": [25] },
                    { "name": "Hebreos", "abbrev": "heb", "chapters": [14, 18, 19, 16, 14, 20, 28, 13, 28, 39, 40, 29, 25] },
                    { "name": "Santiago", "abbrev": "jm", "chapters": [27, 26, 18, 17, 20] },
                    { "name": "1 Pedro", "abbrev": "1pe", "chapters": [25, 25, 22, 19, 14] },
                    { "name": "2 Pedro", "abbrev": "2pe", "chapters": [21, 22, 18] },
                    { "name": "1 Juan", "abbrev": "1jn", "chapters": [10, 29, 24, 21, 21] },
                    { "name": "2 Juan", "abbrev": "2jn", "chapters": [13] },
                    { "name": "3 Juan", "abbrev": "3jn", "chapters": [14] },
                    { "name": "Judas", "abbrev": "jud", "chapters": [25] },
                    { "name": "Apocalipsis", "abbrev": "rv", "chapters": [20, 29, 22, 11, 14, 17, 17, 13, 21, 11, 19, 17, 18, 20, 8, 21, 18, 24, 21, 15, 27, 21] }
                ];
                
                this.DAILY_DEVOTIONAL_THEMES = [
                    // Enero: Fundamentos de la Fe
                    "La Creación de Dios", "La Soberanía de Dios", "La Amor de Dios", "La Fidelidad de Dios", "La Justicia de Dios", "La Misericordia de Dios", "La Santidad de Dios", "La Omnipotencia de Dios", "La Omnisciencia de Dios", "La Omnipresencia de Dios", "La Paciencia de Dios", "La Gracia de Dios", "El Perdón de Dios", "La Veracidad de Dios", "La Naturaleza de Dios (Trinidad)", "La Autoridad de la Biblia", "La Inspiración de la Biblia", "La Inerrancia de la Biblia", "La Relevancia de la Biblia", "Cómo Estudiar la Biblia", "La Oración: Hablar con Dios", "La Adoración: Alabar a Dios", "La Confianza en Dios", "La Esperanza en Dios", "La Fe en Dios", "El Temor de Dios (Reverencia)", "La Obediencia a Dios", "La Salvación por Gracia", "La Redención en Cristo", "El Arrepentimiento Verdadero", "La Conversión Genuina",
                    // Febrero: El Carácter de Cristo
                    "La Deidad de Jesús", "La Humanidad de Jesús", "Jesús: El Verbo Encarnado", "Jesús: El Mesías Prometido", "Jesús: El Siervo Sufriente", "Jesús: El Gran Maestro", "Jesús: El Sanador", "Jesús: El Cordero de Dios", "Jesús: El Buen Pastor", "Jesús: La Luz del Mundo", "Jesús: El Pan de Vida", "Jesús: El Camino, la Verdad y la Vida", "Jesús: La Resurrección y la Vida", "Jesús: El Rey de Reyes", "La Vida sin Pecado de Jesús", "La Compasión de Jesús", "La Autoridad de Jesús", "La Humildad de Jesús", "La Paciencia de Jesús", "El Amor de Jesús", "La Sabiduría de Jesús", "La Oración de Jesús", "El Sacrificio de Jesús", "La Resurrección de Jesús", "La Ascensión de Jesús", "El Regreso de Jesús", "Jesús Nuestro Abogado", "Jesús Nuestro Sumo Sacerdote", "Jesús Nuestro Redentor",
                    // Marzo: La Obra del Espíritu Santo
                    "La Persona del Espíritu Santo", "El Espíritu Santo en la Creación", "El Espíritu Santo en el Antiguo Testamento", "El Espíritu Santo en la Vida de Jesús", "El Bautismo del Espíritu Santo", "El Sello del Espíritu Santo", "El Fruto del Espíritu Santo: Amor", "El Fruto del Espíritu Santo: Gozo", "El Fruto del Espíritu Santo: Paz", "El Fruto del Espíritu Santo: Paciencia", "El Fruto del Espíritu Santo: Benignidad", "El Fruto del Espíritu Santo: Bondad", "El Fruto del Espíritu Santo: Fe", "El Fruto del Espíritu Santo: Mansedumbre", "El Fruto del Espíritu Santo: Templanza", "Los Dones del Espíritu Santo (General)", "El Don de Profecía", "El Don de Enseñanza", "El Don de Servicio", "El Don de Dar", "El Don de Liderazgo", "El Don de Misericordia", "El Don de Discipulado", "El Espíritu Santo Convence de Pecado", "El Espíritu Santo Guía a la Verdad", "El Espíritu Santo Da Poder", "El Espíritu Santo Consuela", "El Espíritu Santo Intercede", "La Llenura del Espíritu Santo", "Andar en el Espíritu", "No Contristar al Espíritu Santo",
                    // Abril: La Vida Cristiana Práctica
                    "El Nuevo Nacimiento", "Vivir por Fe", "La Oración Constante", "El Ayuno Bíblico", "La Meditación en la Palabra", "La Santificación", "La Justificación", "La Glorificación", "La Identidad en Cristo", "Vencer la Tentación", "Vencer el Pecado", "La Lucha Espiritual", "El Crecimiento Espiritual", "La Humildad en la Vida Diaria", "La Gratitud", "La Paciencia", "El Dominio Propio", "La Perseverancia", "La Fidelidad", "La Integridad", "La Generosidad", "El Contentamiento", "La Alegría en el Señor", "La Paz que Sobrepasa Entendimiento", "La Esperanza Viva", "La Mansedumbre", "La Pureza de Corazón", "La Verdad en el Habla", "El Perdón a Otros", "La Reconciliación",
                    // Mayo: Relaciones y Comunión
                    "El Amor Hacia Dios", "El Amor Hacia el Prójimo", "El Matrimonio Cristiano", "Los Roles en el Matrimonio", "La Paternidad y Maternidad Bíblica", "La Educación de los Hijos", "El Respeto a los Padres", "La Amistad Verdadera", "El Amor Fraternal", "La Unidad en la Iglesia", "El Cuerpo de Cristo", "La Importancia de la Comunión", "El Servicio Mutuo", "El Perdón en las Relaciones", "La Resolución de Conflictos", "La Hospitalidad", "La Sumisión (General)", "El Respeto a la Autoridad", "La Evangelización Personal", "El Discipulado", "La Mentoría", "El Animar a Otros", "El Consuelo Mutuo", "La Oración por Otros", "La Carga por los Perdidos", "La Obediencia a los Líderes", "La Admonición Amorosa", "El Ser un Buen Vecino", "La Compasión", "La Justicia Social", "Cuidar de los Necesitados",
                    // Junio: Atributos y Promesas de Dios
                    "Dios es Inmutable", "Dios es Infinito", "Dios es Eterno", "Dios es Bueno", "Dios es Luz", "Dios es Espíritu", "Dios es Creador", "Dios es Sustentador", "Dios es Juez", "Dios es Redentor", "Dios es Consolador", "Dios es Proveedor", "Dios es Sanador", "Dios es Refugio", "Dios es Fortaleza", "Dios es Escudo", "Dios es Roca", "Dios es Pastor", "Dios es Padre", "Dios Cumple Sus Promesas", "Las Promesas de Protección", "Las Promesas de Provisión", "Las Promesas de Paz", "Las Promesas de Gozo", "Las Promesas de Sabiduría", "Las Promesas de Fuerza", "Las Promesas de Descanso", "Las Promesas de Vida Eterna", "La Fidelidad de Dios en la Adversidad", "Confiar en las Promesas de Dios",
                    // Julio: Desafíos y Victorias
                    "Enfrentar el Miedo", "Superar la Ansiedad", "Manejar el Estrés", "Vencer la Preocupación", "Lidiar con la Duda", "Enfrentar la Culpa", "Encontrar Consuelo en el Dolor", "La Disciplina de Dios", "La Paciencia en la Prueba", "La Fe en la Adversidad", "La Gracia en la Debilidad", "La Fuerza en la Tentación", "El Gozo en la Persecución", "La Esperanza en la Desesperación", "La Paz en el Conflicto", "El Contentamiento en la Escasez", "La Sabiduría para Decisiones", "La Paciencia com Otros", "El Amor hacia los Enemigos", "La Victoria sobre el Orgulho", "La Victoria sobre la Ira", "La Victoria sobre la Envidia", "La Victoria sobre la Codicia", "La Victoria sobre la Lujuria", "La Victoria sobre la Glotonería", "La Victoria sobre la Pereza", "La Liberación del Vicio", "La Sanidad Emocional", "La Sanidad Física (si es la voluntad de Dios)", "La Resiliencia Espiritual", "La Victoria en Cristo",
                    // Agosto: La Iglesia y su Misión
                    "El Propósito de la Iglesia", "La Edificación de la Iglesia", "La Adoración en la Iglesia", "La Enseñanza en la Iglesia", "La Comunión en la Iglesia", "El Servicio en la Iglesia", "La Disciplina en la Iglesia", "El Liderazgo en la Iglesia", "Los Ancianos y Diáconos", "La Unidad de la Iglesia", "La Diversidad en la Iglesia", "El Bautismo (Significado)", "La Cena del Señor (Significado)", "La Gran Comisión", "La Evangelización Global", "Las Misiones Transculturales", "El Apoyo a los Misioneros", "La Oración por las Misiones", "El Alcance a la Comunidad", "El Testimonio Cristiano", "La Defensa de la Fe (Apologética)", "La Ética Cristiana", "La Influencia en la Sociedad", "La Luz del Mundo", "La Sal de la Tierra", "La Ciudad sobre la Colina", "La Responsabilidad Social del Cristiano", "El Cuidado de la Creación", "La Paz en el Mundo", "La Justicia en el Mundo", "La Esperanza para el Mundo",
                    // Septiembre: Personajes Bíblicos y sus Lecciones
                    "Adán y Eva: El Origen del Pecado", "Noé: La Obediencia y la Salvación", "Abraham: La Fe y las Promesas", "Sara: La Paciencia y la Risas", "José: El Perdón y la Soberanía de Dios", "Moisés: El Liderazgo y la Liberación", "Rut: La Lealtad y la Redención", "Samuel: La Escucha de Dios", "David: El Corazón Conforme a Dios", "Salomón: La Sabiduría y la Caída", "Elías: El Poder de la Oración", "Eliseo: El Doble de la Unción", "Ester: El Valor para el Reino", "Job: La Fidelidad en el Sufrimiento", "Isaías: El Profeta de la Salvación", "Jeremías: El Profeta Llorón", "Daniel: La Integridad en el Exilio", "Jonás: La Desobediencia y la Misericordia", "Juan el Bautista: El Precursor", "Pedro: La Pasión y la Restauración", "Juan: El Discípulo Amado", "Pablo: El Apóstol a los Gentiles", "María (Madre de Jesús): La Humildad", "Marta y María: Prioridades", "Lázaro: La Resurrección", "Zaqueo: El Arrepentimiento Verdadero", "La Mujer Samaritana: El Agua Viva", "Nicodemo: El Nuevo Nacimiento", "El Centurión: Gran Fe", "El Buen Samaritano: Amor al Prójimo",
                    // Octubre: Profecía y el Fin de los Tiempos
                    "La Profecía Bíblica", "El Plan de Dios a Través de la Historia", "La Escatología (Estudio de los Últimos Tiempos)", "La Segunda Venida de Cristo", "Las Señales de los Tiempos", "El Rapto de la Iglesia (Diferentes puntos de vista)", "El Anticristo", "La Gran Tribulación", "El Reino Milenial de Cristo", "El Juicio Final", "Los Nuevos Cielos y la Nueva Tierra", "La Ciudad Celestial: Nueva Jerusalén", "La Eternidad con Dios", "La Resurrección de los Muertos", "La Esperanza del Creyente", "La Purificación del Mundo", "El Propósito de la Profecía", "Vivir en Expectación", "La Preparación para el Regreso de Cristo", "El Anhelo por la Eternidad", "La Perspectiva Eterna", "La Importancia de la Paciencia", "La Advertencia a los Inconversos", "La Misericordia de Dios hasta el Fin", "El Carácter de Dios en el Juicio", "La Justicia Perfecta de Dios", "La Victoria Final de Cristo", "La Adoración en la Eternidad", "El Descanso del Creyente", "La Consumación de Todas las Cosas", "Amén, Ven Señor Jesús",
                    // Noviembre: Conceptos Clave de la Teología
                    "La Revelación de Dios (General y Especial)", "La Doctrina de Dios (Teología Propia)", "La Doctrina de Cristo (Cristología)", "La Doctrina del Espíritu Santo (Neumatología)", "La Doctrina del Hombre (Antropología)", "La Doctrina del Pecado (Hamartiología)", "La Doctrina de la Salvación (Soteriología)", "La Doctrina de la Iglesia (Eclesiología)", "La Doctrina de los Últimos Tiempos (Escatología)", "El Pacto Abrahámico", "El Pacto Mosaico", "El Pacto Davidico", "El Nuevo Pacto", "La Ley y la Gracia", "El Propósito de la Ley", "La Libertad en Cristo", "La Responsabilidad Humana", "La Elección y la Voluntad de Dios", "La Predestinación (Vista Bíblica)", "La Expiación Sustitutoria", "La Propiciación", "La Justificación por Fe", "La Regeneración", "La Adopción como Hijos de Dios", "La Morada del Espíritu Santo", "La Seguridad de la Salvación", "La Voluntad Permisiva y Perfecta de Dios", "El Mal y el Sufrimiento", "La Soberanía de Dios y el Libre Albedrío", "El Misterio de la Trinidad",
                    // Diciembre: Reflexión y Preparación
                    "El Adviento: Esperanza", "El Adviento: Paz", "El Adviento: Gozo", "El Adviento: Amor", "La Natividad de Jesús (Navidad)", "El Regalo de la Salvación", "El Propósito de la Venida de Jesús", "La Humildad del Nacimiento de Jesús", "La Profecía Cumplida", "La Adoración de los Pastores", "La Adoración de los Magos", "La Importancia del Nombre Jesús", "Emanuel: Dios con Nosotros", "El Año Nuevo: Reflexión", "El Año Nuevo: Gratitud", "El Año Nuevo: Propósitos Espirituales", "Dejar Atrás el Pasado", "Mirar Hacia Adelante", "Confiar en la Guía de Dios", "La Rendición a la Voluntad de Dios", "La Importancia del Tiempo", "El Manejo de los Recursos (Mayordomía)", "La Mayordomía del Cuerpo", "La Mayordomía de los Talentos", "La Mayordomía del Dinero", "La Búsqueda de la Sabiduría", "El Crecimiento Continuo", "La Santidad Personal", "El Legado de Fe", "La Preparación para la Eternidad", "La Gloria de Dios"
                ];

                this.dom = this.getDomElements();
                this.passagesToStudy = [];
                this.savedStudies = []; // Now loaded from Firebase
                this.currentCrossRefs = { list: [], index: 0, analysisIndex: 0 };
                this.currentSessionStudyId = null;
                this.analyzedPassages = new Set();
                this.sessionAnalyses = []; // Accumulates all analysis data for the session
                this.usedDevotionalReferences = []; // Now loaded from Firebase
                this.READING_PLANS = {}; // Populated by generation functions

                // Firebase properties
                this.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                this.firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                this.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                this.db = null;
                this.auth = null;
                this.userId = null;
                this.isAuthReady = false; // Flag to ensure Firebase is initialized and authenticated

                this.init();
            }

            // Centralized DOM element selection
            getDomElements() {
                return {
                    bookSelect: document.getElementById('book'),
                    chapterSelect: document.getElementById('chapter'),
                    verseContainer: document.getElementById('verse-checkbox-grid'),
                    verseSelectorContainer: document.getElementById('verse-selection-container'),
                    selectAllCheckbox: document.getElementById('select-all-verses'),
                    addPassageBtn: document.getElementById('add-passage-btn'),
                    passageList: document.getElementById('passage-list'),
                    analyzeBtn: document.getElementById('analyze-passages-btn'),
                    resultsContainer: document.getElementById('results-container'),
                    savedStudiesList: document.getElementById('saved-studies-list'),
                    versionCheckboxes: document.querySelectorAll('input[type="checkbox"][id^="version-"]'),
                    analysisThemeInput: document.getElementById('analysis-theme-input'),
                    qaInput: document.getElementById('qa-input'),
                    askAiBtn: document.getElementById('ask-ai-btn'),
                    qaResultsContainer: document.getElementById('qa-results-container'),
                    modal: document.getElementById('cross-ref-modal'),
                    modalTitle: document.getElementById('modal-title'),
                    modalBody: document.getElementById('modal-body'),
                    modalCloseBtn: document.getElementById('modal-close'),
                    modalPrevBtn: document.getElementById('modal-prev-btn'),
                    modalNextBtn: document.getElementById('modal-next-btn'),
                    defineWordBtn: document.getElementById('define-word-btn'),
                    dictionaryInput: document.getElementById('dictionary-input'),
                    dictionaryResultsContainer: document.getElementById('dictionary-results-container'),
                    tabLinks: document.querySelectorAll('.tab-link'),
                    tabContents: document.querySelectorAll('.tab-content'),
                    analyzeThemeBtn: document.getElementById('analyze-theme-btn'),
                    thematicInput: document.getElementById('thematic-input'),
                    thematicResultsContainer: document.getElementById('thematic-results-container'),
                    generateDevotionalBtn: document.getElementById('generate-devotional-btn'),
                    forceGenerateDevotionalBtn: document.getElementById('force-generate-devotional-btn'),
                    devotionalOverallStatus: document.getElementById('devotional-overall-status'),
                    devotionalMorningContainer: document.getElementById('devotional-morning-container'),
                    devotionalNightContainer: document.getElementById('devotional-night-container'),
                    historyFilter: document.getElementById('history-filter'),
                    questionGeneratorInput: document.getElementById('question-generator-input'),
                    generateQuestionsBtn: document.getElementById('generate-questions-btn'),
                    questionGeneratorResultsContainer: document.getElementById('question-generator-results-container'),
                    concordanceInput: document.getElementById('concordance-input'),
                    searchConcordanceBtn: document.getElementById('search-concordance-btn'),
                    concordanceResultsContainer: document.getElementById('concordance-results-container'),
                    teachingThemeInput: document.getElementById('teaching-theme-input'),
                    generateTeachingStudyBtn: document.getElementById('generate-teaching-study-btn'),
                    teachingResultsContainer: document.getElementById('teaching-results-container'),
                    genericContentModal: document.getElementById('generic-content-modal'),
                    genericModalTitle: document.getElementById('generic-modal-title'),
                    genericModalBody: document.getElementById('generic-modal-body'),
                    genericModalClose: document.getElementById('generic-modal-close'),
                    genericModalOkBtn: document.getElementById('generic-modal-ok-btn'),
                    readingPlanSelect: document.getElementById('reading-plan-select'),
                    readingPlanDetails: document.getElementById('reading-plan-details'),
                    globalPersonalNotes: document.getElementById('global-personal-notes'),
                    saveSessionStudyBtn: document.getElementById('save-session-study-btn'),
                    exportSessionStudyBtn: document.getElementById('export-session-study-btn'),
                    copyNotesBtn: document.getElementById('copy-notes-btn'),
                    userIdDisplay: document.getElementById('user-id-display')
                };
            }

            // Adds all event listeners
            addEventListeners() {
                // Defensive check to ensure this.dom is initialized
                if (!this.dom) {
                    console.error("Error: this.dom is not initialized.");
                    return; // Exit if DOM elements object is not ready
                }

                if (this.dom.bookSelect) this.dom.bookSelect.addEventListener('change', this.handleBookChange.bind(this));
                if (this.dom.chapterSelect) this.dom.chapterSelect.addEventListener('change', this.handleChapterChange.bind(this));
                if (this.dom.selectAllCheckbox) this.dom.selectAllCheckbox.addEventListener('change', this.handleSelectAllVerses.bind(this));
                if (this.dom.addPassageBtn) this.dom.addPassageBtn.addEventListener('click', this.handleAddPassage.bind(this));
                if (this.dom.analyzeBtn) this.dom.analyzeBtn.addEventListener('click', this.handleAnalyzePassages.bind(this));
                if (this.dom.askAiBtn) this.dom.askAiBtn.addEventListener('click', this.handleAskAI.bind(this));
                if (this.dom.defineWordBtn) this.dom.defineWordBtn.addEventListener('click', this.handleDefineWord.bind(this));
                if (this.dom.analyzeThemeBtn) this.dom.analyzeThemeBtn.addEventListener('click', this.handleAnalyzeTheme.bind(this));
                if (this.dom.generateDevotionalBtn) this.dom.generateDevotionalBtn.addEventListener('click', this.handleGenerateDevotional.bind(this));
                if (this.dom.forceGenerateDevotionalBtn) this.dom.forceGenerateDevotionalBtn.addEventListener('click', this.handleGenerateDevotional.bind(this));
                if (this.dom.historyFilter) this.dom.historyFilter.addEventListener('input', (e) => this.displaySavedStudies(e.target.value));
                if (this.dom.questionGeneratorBtn) this.dom.questionGeneratorBtn.addEventListener('click', this.handleGenerateQuestions.bind(this));
                if (this.dom.searchConcordanceBtn) this.dom.searchConcordanceBtn.addEventListener('click', this.handleConcordanceSearch.bind(this));
                if (this.dom.generateTeachingStudyBtn) this.dom.generateTeachingStudyBtn.addEventListener('click', this.handleGenerateTeachingStudy.bind(this));
                if (this.dom.modalCloseBtn) this.dom.modalCloseBtn.addEventListener('click', this.closeCrossRefModal.bind(this));
                if (this.dom.modalPrevBtn) this.dom.modalPrevBtn.addEventListener('click', () => this.handleCrossRefNav(-1));
                if (this.dom.modalNextBtn) this.dom.modalNextBtn.addEventListener('click', () => this.handleCrossRefNav(1));
                if (this.dom.genericModalClose) this.dom.genericModalClose.addEventListener('click', this.closeGenericModal.bind(this));
                if (this.dom.genericModalOkBtn) this.dom.genericModalOkBtn.addEventListener('click', this.closeGenericModal.bind(this));
                if (this.dom.readingPlanSelect) this.dom.readingPlanSelect.addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.renderReadingPlan(e.target.value);
                    } else {
                        this.dom.readingPlanDetails.innerHTML = '<p>Seleccione un plan de lectura para comenzar.</p>';
                    }
                });

                // Event delegation for dynamically added elements
                document.body.addEventListener('click', this.handleDynamicClicks.bind(this));

                // Tab switching
                if (this.dom.tabLinks) {
                    this.dom.tabLinks.forEach(link => {
                        if (link) link.addEventListener('click', this.handleTabClick.bind(this));
                    });
                }

                // Global Notes buttons
                if (this.dom.globalPersonalNotes) this.dom.globalPersonalNotes.addEventListener('input', () => {
                    this.saveCurrentStudyNotes();
                });
                if (this.dom.copyNotesBtn) this.dom.copyNotesBtn.addEventListener('click', () => {
                    this.copyTextToClipboard(this.dom.globalPersonalNotes.value, this.dom.copyNotesBtn);
                });
                if (this.dom.saveSessionStudyBtn) this.dom.saveSessionStudyBtn.addEventListener('click', () => {
                    if (this.sessionAnalyses.length === 0) {
                        this.showAlert('No hay ningún análisis activo para guardar.');
                        return;
                    }
                    this.saveCurrentStudyToFirestore();
                });
                if (this.dom.exportSessionStudyBtn) this.dom.exportSessionStudyBtn.addEventListener('click', () => {
                    if (this.sessionAnalyses.length === 0) {
                        this.showAlert('No hay ningún análisis activo para exportar. Por favor, analiza al menos un pasaje.');
                        return;
                    }
                    const studyTitle = this.sessionAnalyses.map(a => a.title).join(' & ');
                    const personalNotes = this.dom.globalPersonalNotes.value;
                    const currentStudyObject = {
                        title: `Estudio de: ${studyTitle}`,
                        analyses: this.sessionAnalyses,
                        personal_notes: personalNotes
                    };
                    this.exportStudyToPdf(currentStudyObject);
                });
            }

            // Initializes the application state and event listeners
            init() {
                this.initializeFirebase(); // Initialize Firebase first
                this.initializeGlobalControls();
                this.generateReadingPlans();
                // Populate book select initially
                this.BIBLE_BOOKS.forEach((book, index) => this.dom.bookSelect.add(new Option(book.name, index)));
                this.addEventListeners(); // Add event listeners after DOM is ready and Firebase is being initialized
            }

            // Initializes Firebase and handles authentication
            async initializeFirebase() {
                try {
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebase;
                    const app = initializeApp(this.firebaseConfig);
                    this.db = getFirestore(app);
                    this.auth = getAuth(app);

                    onAuthStateChanged(this.auth, async (user) => {
                        if (user) {
                            this.userId = user.uid;
                            console.log("Firebase authenticated. User ID:", this.userId);
                        } else {
                            // Sign in anonymously if not already authenticated
                            try {
                                if (this.initialAuthToken) {
                                    await signInWithCustomToken(this.auth, this.initialAuthToken);
                                } else {
                                    await signInAnonymously(this.auth);
                                }
                                this.userId = this.auth.currentUser.uid;
                                console.log("Firebase signed in anonymously. User ID:", this.userId);
                            } catch (error) {
                                console.error("Firebase authentication failed:", error);
                                // Fallback to a random ID if auth completely fails (though not ideal for persistence)
                                this.userId = crypto.randomUUID();
                                console.warn("Using a random UUID as userId due to authentication failure.");
                                this.showAlert("Error de autenticación con Firebase. Algunas funciones de guardado no estarán disponibles.");
                            }
                        }
                        this.isAuthReady = true;
                        if (this.dom.userIdDisplay) {
                            this.dom.userIdDisplay.textContent = `Tu ID de usuario: ${this.userId}`;
                        }
                        this.loadAllUserData(); // Load all data once auth is ready
                    });
                } catch (error) {
                    console.error("Error initializing Firebase:", error);
                    this.showAlert("Error al inicializar Firebase. Algunas funciones de guardado no estarán disponibles.");
                    this.userId = crypto.randomUUID(); // Fallback to a random ID
                    this.isAuthReady = true; // Still mark as ready to proceed with limited functionality
                    if (this.dom.userIdDisplay) {
                        this.dom.userIdDisplay.textContent = `Tu ID de usuario (local): ${this.userId}`;
                    }
                    this.loadAllUserData();
                }
            }

            // Loads all user data from Firestore once authenticated
            async loadAllUserData() {
                if (!this.isAuthReady || !this.userId) {
                    console.warn("Firebase no está listo o userId no está disponible para cargar datos.");
                    return;
                }
                console.log("Cargando todos los datos del usuario...");
                await this.loadSavedStudiesFromFirestore();
                await this.loadUsedDevotionalReferences();
                await this.loadLastTeachingStudy();
                this.populatePlanSelector(); // Ensure plans are generated first
                const selectedPlan = this.dom.readingPlanSelect.value;
                if (selectedPlan) {
                    this.renderReadingPlan(selectedPlan);
                }
            }

            // Helper for API calls with exponential backoff
            async fetchWithRetry(url, options, retries = 3, delay = 1000) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) { // Too Many Requests
                            console.warn(`Rate limit hit, retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            return this.fetchWithRetry(url, options, retries - 1, delay * 2);
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json(); // This line parses the JSON and returns the data
                } catch (error) {
                    console.error("Fetch error:", error);
                    throw error;
                }
            }

            // Generic display functions
            displayLoading(container, message) {
                container.innerHTML = `<p class="loading">${message}</p>`;
            }

            displayError(container, message) {
                container.innerHTML = `<div class="error">${message}</div>`;
            }

            // Custom Alert Modal
            showAlert(message) {
                const alertModal = document.createElement('div');
                alertModal.className = 'modal-overlay';
                alertModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4>Mensaje</h4>
                            <button class="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>${message}</p>
                        </div>
                        <div class="modal-nav">
                            <button class="btn btn-primary modal-ok-btn">Aceptar</button>
                        </div>
                    </div>`;
                document.body.appendChild(alertModal);
                alertModal.style.display = 'flex';

                const close = () => document.body.removeChild(alertModal);
                alertModal.querySelector('.modal-ok-btn').onclick = close;
                alertModal.querySelector('.modal-close-btn').onclick = close;
            }

            // Custom Confirm Modal
            showConfirmModal(message, onConfirm) {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'modal-overlay';
                confirmModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4>Confirmar</h4>
                            <button class="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <p>${message}</p>
                        </div>
                        <div class="modal-nav">
                            <button class="btn btn-secondary confirm-cancel-btn">Cancelar</button>
                            <button class="btn btn-danger confirm-ok-btn">Confirmar</button>
                        </div>
                    </div>`;
                document.body.appendChild(confirmModal);
                confirmModal.style.display = 'flex';

                const close = () => document.body.removeChild(confirmModal);
                
                confirmModal.querySelector('.confirm-ok-btn').onclick = () => {
                    onConfirm();
                    close();
                };
                confirmModal.querySelector('.confirm-cancel-btn').onclick = close;
                confirmModal.querySelector('.modal-close-btn').onclick = close;
            }

            // Generic Content Modal (for illustrations, dialogues, view studies)
            openGenericModal(title, contentHtml, extraButtonsHtml = '') {
                this.dom.genericModalTitle.textContent = title;
                this.dom.genericModalBody.innerHTML = contentHtml;
                this.dom.genericContentModal.querySelector('#generic-modal-extra-buttons').innerHTML = extraButtonsHtml;
                this.dom.genericContentModal.style.display = 'flex';
            }

            closeGenericModal() {
                this.dom.genericContentModal.style.display = 'none';
                this.dom.genericContentModal.querySelector('#generic-modal-extra-buttons').innerHTML = '';
                this.dom.genericModalOkBtn.textContent = 'Aceptar';
                this.dom.genericModalOkBtn.style.display = ''; // Make sure it's visible
            }

            // Makes Bible references clickable within text
            makeCitationsClickable(text) {
                if (!text) return '';
                const parser = new DOMParser();
                const doc = parser.parseFromString(`<div>${text}</div>`, 'text/html');
                const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT);
                let node;
                const nodesToReplace = [];

                while (node = walker.nextNode()) {
                    const matches = [...node.nodeValue.matchAll(/\[\[(.*?)\]\]/g)];
                    if (matches.length > 0) {
                        nodesToReplace.push({node, matches});
                    }
                }

                nodesToReplace.forEach(({node, matches}) => {
                    const parent = node.parentNode;
                    let lastIndex = 0;
                    matches.forEach(match => {
                        const beforeText = node.nodeValue.substring(lastIndex, match.index);
                        if (beforeText) {
                            parent.insertBefore(document.createTextNode(beforeText), node);
                        }
                        const link = document.createElement('a');
                        link.href = '#';
                        link.className = 'devotional-verse-link';
                        link.dataset.reference = match[1];
                        link.textContent = match[1];
                        parent.insertBefore(link, node);
                        lastIndex = match.index + match[0].length;
                    });
                    const afterText = node.nodeValue.substring(lastIndex);
                    if(afterText){
                        parent.insertBefore(document.createTextNode(afterText), node);
                    }
                    parent.removeChild(node);
                });
                return doc.body.innerHTML;
            }

            // Updates the list of passages selected for study
            updatePassageList() {
                this.dom.passageList.innerHTML = '';
                this.passagesToStudy.forEach((passage, index) => {
                    const li = document.createElement('li');
                    li.textContent = passage;
                    
                    if (this.analyzedPassages.has(passage)) {
                        li.style.backgroundColor = '#d4edda'; // Light green for success
                        li.style.color = '#155724';
                        li.style.borderLeft = '4px solid var(--success-color)';
                        li.title = 'Este pasaje ya ha sido analizado en esta sesión.';
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Quitar';
                    removeBtn.className = 'remove-btn';
                    removeBtn.onclick = () => {
                        const removedPassage = this.passagesToStudy.splice(index, 1)[0];
                        if (this.analyzedPassages.has(removedPassage)) {
                            this.analyzedPassages.delete(removedPassage);
                            this.sessionAnalyses = this.sessionAnalyses.filter(analysis => analysis.title !== removedPassage);
                            this.dom.resultsContainer.innerHTML = '';
                            this.sessionAnalyses.forEach(analysis => this.appendAnalysisResults([analysis]));
                        }
                        this.updatePassageList();

                        if (this.passagesToStudy.length === 0) {
                            this.resetCurrentStudy();
                        }
                    };
                    li.appendChild(removeBtn);
                    this.dom.passageList.appendChild(li);
                });
                this.dom.analyzeBtn.disabled = this.passagesToStudy.length === 0;
            }

            // Formats selected verse numbers into a query string (e.g., "1,3-5")
            formatVerseQuery(numbers) {
                if (!numbers || numbers.length === 0) return '';
                numbers.sort((a, b) => a - b);
                const ranges = [];
                let start = numbers[0], end = numbers[0];
                for (let i = 1; i < numbers.length; i++) {
                    if (numbers[i] === end + 1) end = numbers[i];
                    else {
                        ranges.push(start === end ? `${start}` : `${start}-${end}`);
                        start = end = numbers[i];
                    }
                }
                ranges.push(start === end ? `${start}` : `${start}-${end}`);
                return ranges.join(',');
            }

            // Appends new analysis results to the display area
            appendAnalysisResults(analyses) {
                let resultsHtml = '';
                analyses.forEach((analysis) => {
                    const globalIndex = this.sessionAnalyses.findIndex(item => item.title === analysis.title);

                    let versionComparisonHtml = '';
                    if (analysis.version_comparison && analysis.version_comparison.length > 1) {
                        const versions = analysis.version_comparison;
                        const versionNames = versions.map(v => v.version);
                        const pivotedData = {};

                        versions.forEach(version => {
                            version.verses.forEach(verse => {
                                if (!pivotedData[verse.verse_number]) {
                                    pivotedData[verse.verse_number] = {};
                                }
                                pivotedData[verse.verse_number][version.version] = verse.text;
                            });
                        });
                        
                        versionComparisonHtml = `<div class="version-comparison-section"><h4 class="section-title">Comparación de Versiones <button class="copy-btn" data-copy-target="version-comparison-${globalIndex}">Copiar</button></h4><table class="styled-table" id="version-comparison-${globalIndex}"><thead><tr><th>Ver.</th>`;
                        versionNames.forEach(name => {
                               versionComparisonHtml += `<th>${name}</th>`;
                        });
                        versionComparisonHtml += `</tr></thead><tbody>`;

                        for (const verseNum in pivotedData) {
                            versionComparisonHtml += `<tr><td><b>${verseNum}</b></td>`;
                            versionNames.forEach(name => {
                                versionComparisonHtml += `<td>${pivotedData[verseNum][name] || ''}</td>`;
                            });
                            versionComparisonHtml += `</tr>`;
                        }
                        versionComparisonHtml += `</tbody></table></div>`;
                    }

                    let characterProfilesHtml = '';
                    if (analysis.character_profiles && analysis.character_profiles[0] !== "No se mencionan personajes principales") {
                        characterProfilesHtml = `<div class="character-profiles-section">
                            <h4 class="section-title">Perfiles de Personajes <button class="copy-btn" data-copy-target="character-profiles-${globalIndex}">Copiar</button></h4>
                            <div id="character-profiles-${globalIndex}">`;
                        analysis.character_profiles.forEach((profile, charIndex) => {
                            characterProfilesHtml += `
                                <div class="character-profile-item" style="margin-bottom: 1rem; border-left: 3px solid var(--ai-feature-color); padding-left: 1rem;">
                                    <p>${this.makeCitationsClickable(profile)}</p>
                                    <button class="btn btn-ai btn-sm generate-dialogue-btn" data-analysis-index="${globalIndex}" data-character-index="${charIndex}">✨ Generar Diálogo Ficticio</button>
                                </div>
                            `;
                        });
                        characterProfilesHtml += `</div></div>`;
                    }
                    
                    let keywordsTable = `<div class="keywords-section"><h4 class="section-title">Análisis de Palabras Clave <button class="copy-btn" data-copy-target="keywords-${globalIndex}">Copiar</button></h4><table class="styled-table" id="keywords-${globalIndex}"><tr><th>Original (Significado)</th><th>Transliteración</th><th>Strong</th><th>Definición Expositiva</th></tr>`;
                    analysis.keywords.forEach(kw => {
                        keywordsTable += `<tr>
                            <td class="hebrew-word">
                                <a href="#" class="keyword-link" data-word="${kw.original_word}" data-translit="${kw.transliteration}" data-strong="${kw.strong_number}">${kw.original_word}</a> 
                                (${kw.spanish_meaning || 'N/A'})
                            </td>
                            <td><em>${kw.transliteration}</em></td>
                            <td>${kw.strong_number}</td>
                            <td>${kw.expository_definition}</td>
                        </tr>`;
                    });
                    keywordsTable += '</table></div>';

                    let crossRefHtml = `<div class="context-section"><h4 class="section-title">Referencias Cruzadas <button class="copy-btn" data-copy-target="cross-references-${globalIndex}">Copiar</button></h4><ul class="cross-ref-list" id="cross-references-${globalIndex}">`;
                    analysis.cross_references.forEach((ref, refIndex) => {
                        crossRefHtml += `<li><a href="#" class="cross-ref-link" data-analysis-index="${globalIndex}" data-ref-index="${refIndex}">${ref}</a></li>`;
                    });
                    crossRefHtml += `</ul></div>`;
                    
                    const referenceBase = analysis.title.substring(0, analysis.title.lastIndexOf(':'));
                    let highlightedVerseText = analysis.verses_highlighted.map(v => `<span class="verse-item"><b>${referenceBase}:${v.verse_number}</b> ${v.verse_text_html}</span>`).join(' ');
                    
                    let practicalApplicationHtml = analysis.practical_application ? `<div class="application-section"><h4 class="section-title">Aplicación Práctica <button class="copy-btn" data-copy-target="practical-application-${globalIndex}">Copiar</button></h4><div id="practical-application-${globalIndex}">${this.makeCitationsClickable(analysis.practical_application)}</div></div>` : '';
                    
                    let sermonOutlineHtml = '';
                    if (analysis.sermon_outline && analysis.sermon_outline.title) {
                        sermonOutlineHtml = `
                            <div class="sermon-outline-section">
                                <h4 class="section-title">Bosquejo para Sermón/Estudio <button class="copy-btn" data-copy-target="sermon-outline-${globalIndex}">Copiar</button></h4>
                                <div id="sermon-outline-${globalIndex}">
                                    <h5>${analysis.sermon_outline.title}</h5>
                                    <p><strong>Introducción:</strong> ${this.makeCitationsClickable(analysis.sermon_outline.introduction)}</p>
                                    <ul>`;
                        analysis.sermon_outline.main_points.forEach(mainPoint => {
                            sermonOutlineHtml += `<li><strong>${this.makeCitationsClickable(mainPoint.point)}</strong>`;
                            if (mainPoint.subpoints && mainPoint.subpoints.length > 0) {
                                sermonOutlineHtml += `<ul style="margin-top: 0.5rem;">`;
                                mainPoint.subpoints.forEach(subpoint => {
                                    sermonOutlineHtml += `<li>${this.makeCitationsClickable(subpoint)}</li>`;
                                });
                                sermonOutlineHtml += `</ul>`;
                            }
                            sermonOutlineHtml += `</li>`;
                        });
                        sermonOutlineHtml += `</ul>
                                    <p><strong>Conclusión:</strong> ${this.makeCitationsClickable(analysis.sermon_outline.conclusion)}</p>
                                </div>
                                <div style="text-align: right; margin-top: 1rem;">
                                    <button class="btn btn-ai btn-sm generate-illustrations-btn" data-analysis-index="${globalIndex}">✨ Sugerir Ilustraciones</button>
                                </div>
                            </div>`;
                    }

                    let prayerPointsHtml = analysis.prayer_points && analysis.prayer_points.length > 0 ? `<div class="prayer-points-section"><h4 class="section-title">Puntos de Oración <button class="copy-btn" data-copy-target="prayer-points-${globalIndex}">Copiar</button></h4><ul id="prayer-points-${globalIndex}">${analysis.prayer_points.map(item => `<li>${this.makeCitationsClickable(item)}</li>`).join('')}</ul></div>` : '';
                    
                    let deeperContextHtml = '';
                    if (analysis.deeper_context) {
                        deeperContextHtml = `
                            <div class="context-section">
                                <h4 class="section-title">Estudio Arqueológico, Cultural e Histórico <button class="copy-btn" data-copy-target="deeper-context-${globalIndex}">Copiar</button></h4>
                                <div id="deeper-context-${globalIndex}">
                                    <h5><i class="fas fa-landmark"></i> Trasfondo Histórico</h5>
                                    <p>${this.makeCitationsClickable(analysis.deeper_context.historical_background)}</p>
                                    <h5><i class="fas fa-users"></i> Costumbres Culturales</h5>
                                    <p>${this.makeCitationsClickable(analysis.deeper_context.cultural_customs)}</p>
                                    <h5><i class="fas fa-gem"></i> Hallazgos Arqueológicos</h5>
                                    <p>${this.makeCitationsClickable(analysis.deeper_context.archaeological_findings)}</p>
                                    <h5><i class="fas fa-map-marked-alt"></i> Entorno Geográfico</h5>
                                    <p>${this.makeCitationsClickable(analysis.deeper_context.geographical_setting)}</p>
                                </div>
                            </div>
                        `;
                    }

                    resultsHtml += `
                        <div class="analysis-card" id="analysis-${globalIndex}">
                            <div class="analysis-card-header">
                                <h3>${analysis.title}</h3>
                            </div>
                            <div class="card-content">
                                <h4 class="section-title">Texto del Pasaje (King James - Español) <button class="copy-btn" data-copy-target="highlighted-text-${globalIndex}">Copiar</button></h4>
                                <blockquote id="highlighted-text-${globalIndex}" class="verse-horizontal-list">${highlightedVerseText}</blockquote>
                                ${versionComparisonHtml}
                                <div class="reflection-section"><h4 class="section-title">Género Literario <button class="copy-btn" data-copy-target="literary-genre-${globalIndex}">Copiar</button></h4><p id="literary-genre-${globalIndex}"><em>${analysis.literary_genre}</em></p></div>
                                ${characterProfilesHtml}
                                <div class="reflection-section"><h4 class="section-title">Reflexión Teológica <button class="copy-btn" data-copy-target="reflection-text-${globalIndex}">Copiar</button></h4><div id="reflection-text-${globalIndex}">${this.makeCitationsClickable(analysis.reflection_text)}</div></div>
                                ${practicalApplicationHtml}
                                ${sermonOutlineHtml}
                                ${prayerPointsHtml}
                                ${deeperContextHtml}
                                ${crossRefHtml}
                                ${keywordsTable}
                                <div style="text-align: right; margin-top: 1rem;">
                                    <button class="btn btn-ai btn-sm generate-timeline-btn" data-analysis-index="${globalIndex}">✨ Ver Línea de Tiempo</button>
                                </div>
                            </div>
                        </div>`;
                });
                this.dom.resultsContainer.innerHTML += resultsHtml;
                
                if (this.sessionAnalyses.length > 0) {
                    this.dom.saveSessionStudyBtn.disabled = false;
                    this.dom.exportSessionStudyBtn.disabled = false;
                }
            }

            // Displays saved studies in the history tab
            async displaySavedStudies(filter = '') {
                if (!this.isAuthReady || !this.userId) {
                    this.dom.savedStudiesList.innerHTML = '<li>Cargando estudios guardados...</li>';
                    return;
                }

                const { collection, query, onSnapshot, orderBy } = window.firebase;
                const studiesCollectionRef = collection(this.db, `artifacts/${this.appId}/users/${this.userId}/savedStudies`);
                
                // Use onSnapshot for real-time updates
                onSnapshot(studiesCollectionRef, (snapshot) => {
                    this.savedStudies = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        this.savedStudies.push({ ...data, id: doc.id });
                    });

                    this.dom.savedStudiesList.innerHTML = '';
                    const filteredStudies = this.savedStudies.filter(study => 
                        study.title.toLowerCase().includes(filter.toLowerCase()) || 
                        (study.tags && study.tags.toLowerCase().includes(filter.toLowerCase()))
                    );

                    filteredStudies.sort((a, b) => new Date(b.saved_date) - new Date(a.saved_date));

                    if (filteredStudies.length === 0) {
                        this.dom.savedStudiesList.innerHTML = '<li>No hay estudios guardados que coincidan con el filtro.</li>';
                    }

                    filteredStudies.forEach((study) => {
                        const li = document.createElement('li');
                        li.onclick = () => {
                            this.resetCurrentStudy();
                            
                            this.sessionAnalyses = study.analyses.map(analysis => {
                                // Parse analyses if they were stringified
                                if (typeof analysis === 'string') {
                                    try {
                                        return JSON.parse(analysis);
                                    } catch (e) {
                                        console.error("Error parsing analysis string:", e);
                                        return {}; // Return empty or handle error
                                    }
                                }
                                return analysis;
                            });
                            this.analyzedPassages = new Set(this.sessionAnalyses.map(a => a.title));
                            this.passagesToStudy = [...this.analyzedPassages];
                            this.currentSessionStudyId = study.id; // Use Firestore doc ID as session study ID
                            
                            window.currentAnalyses = this.sessionAnalyses; // For compatibility
                            this.updatePassageList();
                            this.dom.resultsContainer.innerHTML = '';
                            this.sessionAnalyses.forEach(analysis => this.appendAnalysisResults([analysis]));
                            
                            if (this.dom.globalPersonalNotes) {
                                const notes = study.personal_notes || '';
                                this.dom.globalPersonalNotes.value = notes;
                                // No need to save to localStorage here, as it's loaded from Firebase
                            }
                            
                            this.dom.saveSessionStudyBtn.disabled = false;
                            this.dom.exportSessionStudyBtn.disabled = false;
                        };

                        const studyTitleSpan = document.createElement('span');
                        studyTitleSpan.textContent = study.title;
                        studyTitleSpan.style.flexGrow = 1;
                        studyTitleSpan.style.marginRight = '1rem';

                        const buttonsDiv = document.createElement('div');
                        buttonsDiv.style.display = 'flex';
                        buttonsDiv.style.flexShrink = 0;

                        const viewBtn = document.createElement('button');
                        viewBtn.innerHTML = '<i class="fas fa-eye"></i> Ver';
                        viewBtn.className = 'view-history-btn';
                        viewBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.viewStudyInModal(study);
                        };

                        const exportPdfBtn = document.createElement('button');
                        exportPdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF';
                        exportPdfBtn.className = 'export-history-btn';
                        exportPdfBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.exportStudyToPdf(study);
                        };

                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '<i class="fas fa-trash"></i> Borrar';
                        removeBtn.className = 'remove-btn';
                        removeBtn.onclick = (e) => {
                            e.stopPropagation();
                            this.showConfirmModal(`¿Seguro que quieres borrar el estudio de "${study.title}"?`, async () => {
                                try {
                                    const { doc, deleteDoc } = window.firebase;
                                    await deleteDoc(doc(this.db, `artifacts/${this.appId}/users/${this.userId}/savedStudies`, study.id));
                                    this.showAlert(`¡Estudio "${study.title}" borrado con éxito!`);
                                    if (this.currentSessionStudyId === study.id) {
                                        this.resetCurrentStudy();
                                    }
                                } catch (error) {
                                    console.error("Error deleting study:", error);
                                    this.showAlert(`Error al borrar el estudio: ${error.message}`);
                                }
                            });
                        };
                        
                        li.appendChild(studyTitleSpan);
                        buttonsDiv.appendChild(viewBtn);
                        buttonsDiv.appendChild(exportPdfBtn);
                        buttonsDiv.appendChild(removeBtn);
                        li.appendChild(buttonsDiv);
                        this.dom.savedStudiesList.appendChild(li);
                    });
                }, (error) => {
                    console.error("Error fetching saved studies:", error);
                    this.dom.savedStudiesList.innerHTML = `<li>Error al cargar estudios guardados: ${error.message}</li>`;
                });
            }

            // Saves the current session study to Firestore
            async saveCurrentStudyToFirestore() {
                if (!this.isAuthReady || !this.userId) {
                    this.showAlert("Firebase no está listo. No se puede guardar el estudio.");
                    return;
                }

                const { doc, setDoc, addDoc, collection } = window.firebase;
                const studiesCollectionRef = collection(this.db, `artifacts/${this.appId}/users/${this.userId}/savedStudies`);
                
                const studyTitle = `Estudio de: ${this.sessionAnalyses.map(a => a.title).join(' & ')}`;
                const personalNotes = this.dom.globalPersonalNotes.value;

                const studyData = {
                    title: studyTitle,
                    analyses: this.sessionAnalyses.map(analysis => JSON.stringify(analysis)), // Stringify complex objects
                    personal_notes: personalNotes,
                    saved_date: new Date().toISOString()
                };

                try {
                    if (this.currentSessionStudyId) {
                        // Update existing study
                        const studyRef = doc(studiesCollectionRef, this.currentSessionStudyId);
                        await setDoc(studyRef, studyData, { merge: true });
                        this.showAlert(`¡Estudio actualizado con éxito!`);
                    } else {
                        // Add new study
                        const newDocRef = await addDoc(studiesCollectionRef, studyData);
                        this.currentSessionStudyId = newDocRef.id;
                        this.showAlert(`¡Estudio guardado con éxito!`);
                    }
                } catch (error) {
                    console.error("Error saving study to Firestore:", error);
                    this.showAlert(`Error al guardar el estudio: ${error.message}`);
                }
            }

            // Loads saved studies from Firestore
            async loadSavedStudiesFromFirestore() {
                if (!this.isAuthReady || !this.userId) {
                    console.warn("Firebase no está listo para cargar estudios.");
                    return;
                }
                // onSnapshot is already handling real-time updates in displaySavedStudies
                // So, no need for a separate load function here, just ensure displaySavedStudies is called
                this.displaySavedStudies(); 
            }

            // Saves current study notes to Firestore
            async saveCurrentStudyNotes() {
                if (!this.isAuthReady || !this.userId) {
                    // console.warn("Firebase no está listo. No se pueden guardar las notas.");
                    return; // Don't alert for every keystroke, just log
                }
                const { doc, setDoc } = window.firebase;
                const notesDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/currentSessionNotes/notes`);
                try {
                    await setDoc(notesDocRef, {
                        notes: this.dom.globalPersonalNotes.value,
                        last_updated: new Date().toISOString()
                    }, { merge: true });
                } catch (error) {
                    console.error("Error saving current notes to Firestore:", error);
                }
            }

            // Loads current study notes from Firestore
            async loadCurrentStudyNotes() {
                if (!this.isAuthReady || !this.userId) {
                    console.warn("Firebase no está listo para cargar notas.");
                    return;
                }
                const { doc, getDoc } = window.firebase;
                const notesDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/currentSessionNotes/notes`);
                try {
                    const docSnap = await getDoc(notesDocRef);
                    if (docSnap.exists()) {
                        this.dom.globalPersonalNotes.value = docSnap.data().notes || '';
                    } else {
                        this.dom.globalPersonalNotes.value = '';
                    }
                } catch (error) {
                    console.error("Error loading current notes from Firestore:", error);
                    this.dom.globalPersonalNotes.value = ''; // Clear on error
                }
            }

            // Opens the cross-reference modal and fetches the verse
            async openCrossRefModal(analysisIndex, refIndex) {
                this.currentCrossRefs.list = this.sessionAnalyses[analysisIndex].cross_references;
                this.currentCrossRefs.index = parseInt(refIndex, 10);
                this.currentCrossRefs.analysisIndex = parseInt(analysisIndex, 10);

                const ref = this.currentCrossRefs.list[this.currentCrossRefs.index];
                this.dom.modalTitle.textContent = ref;
                this.displayLoading(this.dom.modalBody, 'Cargando...');
                this.dom.modal.style.display = 'flex';
                
                try {
                    const prompt = `Devuelve única y exclusivamente el texto bíblico para la referencia "${ref}" de la versión King James en español, sin ninguna frase introductoria. Responde únicamente en español.`;
                    const geminiPayload = { contents: [{ parts: [{ text: prompt }] }] };
                    
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });
                    const text = data.candidates[0].content.parts[0].text;
                    this.dom.modalBody.innerHTML = `<p>${text}</p>`;
                } catch (error) {
                    this.displayError(this.dom.modalBody, `No se pudo obtener el texto de la referencia: ${error.message}`);
                }
            }

            // Displays a single verse in the modal (used for devotional links)
            async displayVerseInModal(reference) {
                this.dom.modalTitle.textContent = reference;
                this.displayLoading(this.dom.modalBody, 'Cargando versículo...');
                this.dom.modal.style.display = 'flex';

                try {
                    const prompt = `Devuelve única y exclusivamente el texto bíblico para la referencia "${reference}" de la versión King James en español, sin ninguna frase introductoria. Responde únicamente en español.`;
                    const geminiPayload = { contents: [{ parts: [{ text: prompt }] }] };
                    
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });
                    const text = data.candidates[0].content.parts[0].text;
                    this.dom.modalBody.innerHTML = `<p>${text}</p>`;
                } catch (error) {
                    this.displayError(this.dom.modalBody, `No se pudo obtener el texto de la referencia: ${error.message}`);
                }
                this.dom.modalPrevBtn.style.display = 'none';
                this.dom.modalNextBtn.style.display = 'none';
            }
            
            // Closes the cross-reference modal
            closeCrossRefModal() {
                this.dom.modal.style.display = 'none';
                this.dom.modalPrevBtn.style.display = '';
                this.dom.modalNextBtn.style.display = '';
            }

            // Handles navigation for cross-references within the modal
            handleCrossRefNav(direction) {
                const newIndex = this.currentCrossRefs.index + direction;
                if (newIndex >= 0 && newIndex < this.currentCrossRefs.list.length) {
                    this.openCrossRefModal(this.currentCrossRefs.analysisIndex, newIndex);
                }
            }

            // Views a saved study in a generic modal
            viewStudyInModal(study) {
                this.dom.genericModalTitle.textContent = study.title;

                let studyHtml = '';
                // Ensure analyses are parsed if they were stringified for Firestore
                const analysesToRender = study.analyses.map(analysis => {
                    if (typeof analysis === 'string') {
                        try {
                            return JSON.parse(analysis);
                        } catch (e) {
                            console.error("Error parsing analysis string for view:", e);
                            return {};
                        }
                    }
                    return analysis;
                });

                analysesToRender.forEach(analysis => {
                    studyHtml += `<h3>${analysis.title}</h3>`;
                    
                    const referenceBase = analysis.title.substring(0, analysis.title.lastIndexOf(':'));
                    const highlightedText = analysis.verses_highlighted.map(v => `<b>${referenceBase}:${v.verse_number}</b> ${v.verse_text_html.replace(/<\/?u>/g, '')}`).join('<br>');
                    studyHtml += `<h4>Texto del Pasaje</h4><p>${highlightedText}</p>`;

                    studyHtml += `<h4>Reflexión Teológica</h4><p>${analysis.reflection_text}</p>`;
                    
                    if (analysis.practical_application) {
                         studyHtml += `<h4>Aplicación Práctica</h4><p>${analysis.practical_application}</p>`;
                    }
                    if (analysis.prayer_points && analysis.prayer_points.length > 0) {
                        studyHtml += `<h4>Puntos de Oración</h4><ul>${analysis.prayer_points.map(p => `<li>${p}</li>`).join('')}</ul>`;
                    }
                    studyHtml += '<hr style="border: 0; border-top: 1px solid var(--border-color); margin: 1.5rem 0;">';
                });

                if (study.personal_notes) {
                    studyHtml += `<h3>Notas Personales</h3><p>${study.personal_notes.replace(/\n/g, '<br>')}</p>`;
                }

                const extraButtons = `
                    <button id="copy-view-study-btn" class="btn btn-secondary">Copiar Estudio</button>
                `;
                this.openGenericModal(study.title, this.makeCitationsClickable(studyHtml), extraButtons);

                document.getElementById('copy-view-study-btn').onclick = () => {
                    const textToCopy = this.dom.genericModalBody.innerText;
                    this.copyTextToClipboard(textToCopy, document.getElementById('copy-view-study-btn'));
                };
            }

            // Exports a study to PDF
            exportStudyToPdf(studyObject) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                const MARGIN = 15;
                const PAGE_WIDTH = doc.internal.pageSize.getWidth();
                const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
                const MAX_WIDTH = PAGE_WIDTH - (2 * MARGIN);
                
                const FONT_SIZES = {
                    title: 18,
                    passageTitle: 14,
                    sectionHeader: 11,
                    body: 10,
                    small: 9
                };
                
                let yPos = MARGIN;

                const checkPageBreak = (requiredHeight) => {
                    if (yPos + requiredHeight > PAGE_HEIGHT - MARGIN) {
                        doc.addPage();
                        yPos = MARGIN;
                    }
                };

                const writeText = (text, options) => {
                    const {
                        x = MARGIN,
                        fontStyle = 'normal',
                        fontSize = FONT_SIZES.body,
                        align = 'left',
                        isHeader = false,
                        spaceAfter = 4,
                        color = [0, 0, 0]
                    } = options;

                    doc.setFont('helvetica', fontStyle);
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);

                    const textLines = doc.splitTextToSize(text.replace(/\[\[(.*?)\]\]/g, '$1'), MAX_WIDTH - (x - MARGIN));
                    const textHeight = doc.getTextDimensions(textLines).h;

                    checkPageBreak(textHeight + (isHeader ? 3 : 0));
                    
                    if (isHeader && yPos > MARGIN) {
                            yPos += 3; // Extra space before a new section header
                    }

                    doc.text(textLines, x, yPos, { align: align });
                    yPos += textHeight + spaceAfter;
                };

                // 1. MAIN STUDY TITLE
                writeText(studyObject.title, {
                    fontSize: FONT_SIZES.title,
                    fontStyle: 'bold',
                    align: 'center',
                    x: PAGE_WIDTH / 2,
                    spaceAfter: 10
                });

                // 2. LOOP THROUGH EACH ANALYSIS
                studyObject.analyses.forEach((analysis, index) => {
                    // Ensure analysis is parsed if it was stringified for Firestore
                    let currentAnalysis = analysis;
                    if (typeof analysis === 'string') {
                        try {
                            currentAnalysis = JSON.parse(analysis);
                        } catch (e) {
                            console.error("Error parsing analysis string for PDF:", e);
                            return; // Skip this analysis if parsing fails
                        }
                    }

                    if (index > 0) {
                        checkPageBreak(15); // Space for separator line
                        yPos += 5; 
                        doc.setDrawColor(180, 180, 180);
                        doc.line(MARGIN, yPos, MAX_WIDTH + MARGIN, yPos);
                        yPos += 10;
                    }
                    
                    // Passage Title
                    writeText(currentAnalysis.title, { fontSize: FONT_SIZES.passageTitle, fontStyle: 'bold', spaceAfter: 8 });

                    const renderSection = (title, content) => {
                        if (!content || (Array.isArray(content) && content.length === 0) || content === "No se mencionan personajes principales") return;
                        
                        writeText(title, { fontSize: FONT_SIZES.sectionHeader, fontStyle: 'bold', isHeader: true, spaceAfter: 2 });
                        
                        if (typeof content === 'string') {
                            writeText(content, { fontSize: FONT_SIZES.body });
                        } else if (Array.isArray(content)) {
                            content.forEach(item => {
                                if (typeof item === 'object' && item.original_word) { // Keywords
                                        const keywordText = `${item.original_word} (${item.spanish_meaning}) - ${item.transliteration} (${item.strong_number}): ${item.expository_definition}`;
                                        writeText(`• ${keywordText}`, { fontSize: FONT_SIZES.body, spaceAfter: 2 });
                                } else { // Simple string array
                                        writeText(`• ${item}`, { fontSize: FONT_SIZES.body, spaceAfter: 2 });
                                }
                            });
                            yPos += 3; // Add space after the list
                        }
                    };
                    
                    writeText('Texto del Pasaje (King James)', { fontSize: FONT_SIZES.sectionHeader, fontStyle: 'bold', isHeader: true, spaceAfter: 2 });
                    writeText(currentAnalysis.verses_highlighted.map(v => `(${v.verse_number}) ${v.verse_text_html.replace(/<u>/g, '').replace(/<\/u>/g, '')}`).join(' '), { fontSize: FONT_SIZES.body });

                    if (currentAnalysis.version_comparison && currentAnalysis.version_comparison.length > 1) {
                        writeText('Comparación de Versiones', { fontSize: FONT_SIZES.sectionHeader, fontStyle: 'bold', isHeader: true, spaceAfter: 2 });
                        const versions = currentAnalysis.version_comparison;
                        const pivotedData = {};
                        versions.forEach(version => {
                            version.verses.forEach(verse => {
                                if (!pivotedData[verse.verse_number]) pivotedData[verse.verse_number] = {};
                                pivotedData[verse.verse_number][version.version] = verse.text;
                            });
                        });

                        for (const verseNum in pivotedData) {
                            writeText(`Versículo ${verseNum}`, { fontSize: FONT_SIZES.body, fontStyle: 'bold', spaceAfter: 2 });
                            for (const versionName in pivotedData[verseNum]) {
                                writeText(`${versionName}: ${pivotedData[verseNum][versionName]}`, { fontSize: FONT_SIZES.small, fontStyle: 'italic', x: MARGIN + 5, spaceAfter: 3 });
                            }
                        }
                        yPos += 5;
                    }

                    renderSection('Género Literario', currentAnalysis.literary_genre);
                    renderSection('Perfiles de Personajes', currentAnalysis.character_profiles);
                    renderSection('Reflexión Teológica', currentAnalysis.reflection_text);
                    renderSection('Aplicación Práctica', currentAnalysis.practical_application);

                    // Sermon Outline
                    if (currentAnalysis.sermon_outline && currentAnalysis.sermon_outline.title) {
                        writeText('Bosquejo para Sermón/Estudio', { fontSize: FONT_SIZES.sectionHeader, fontStyle: 'bold', isHeader: true, spaceAfter: 2 });
                        writeText(currentAnalysis.sermon_outline.title, { fontSize: FONT_SIZES.body, fontStyle: 'bold' });
                        writeText(`Introducción: ${currentAnalysis.sermon_outline.introduction}`, { fontSize: FONT_SIZES.body });
                        currentAnalysis.sermon_outline.main_points.forEach(point => {
                            writeText(point.point, { fontSize: FONT_SIZES.body, fontStyle: 'bold', x: MARGIN + 5, spaceAfter: 2 });
                            if (point.subpoints && point.subpoints.length > 0) {
                                point.subpoints.forEach(subpoint => {
                                    writeText(`- ${subpoint}`, { fontSize: FONT_SIZES.body, x: MARGIN + 10, spaceAfter: 2 });
                                });
                            }
                        });
                        writeText(`Conclusión: ${currentAnalysis.sermon_outline.conclusion}`, { fontSize: FONT_SIZES.body });
                        yPos += 5;
                    }

                    renderSection('Puntos de Oración', currentAnalysis.prayer_points);
                    
                    if (currentAnalysis.deeper_context) {
                        writeText('Estudio Arqueológico, Cultural e Histórico', { fontSize: FONT_SIZES.sectionHeader, fontStyle: 'bold', isHeader: true, spaceAfter: 2 });
                        writeText('Trasfondo Histórico', { fontSize: FONT_SIZES.body, fontStyle: 'bold', x: MARGIN + 5, spaceAfter: 2 });
                        writeText(currentAnalysis.deeper_context.historical_background, { fontSize: FONT_SIZES.body, x: MARGIN + 5 });
                        yPos += 2;
                        writeText('Costumbres Culturales', { fontSize: FONT_SIZES.body, fontStyle: 'bold', x: MARGIN + 5, spaceAfter: 2 });
                        writeText(currentAnalysis.deeper_context.cultural_customs, { fontSize: FONT_SIZES.body, x: MARGIN + 5 });
                        yPos += 2;
                        writeText('Hallazgos Arqueológicos', { fontSize: FONT_SIZES.body, fontStyle: 'bold', x: MARGIN + 5, spaceAfter: 2 });
                        writeText(currentAnalysis.deeper_context.archaeological_findings, { fontSize: FONT_SIZES.body, x: MARGIN + 5 });
                        yPos += 2;
                        writeText('Entorno Geográfico', { fontSize: FONT_SIZES.body, fontStyle: 'bold', x: MARGIN + 5, spaceAfter: 2 });
                        writeText(currentAnalysis.deeper_context.geographical_setting, { fontSize: FONT_SIZES.body, x: MARGIN + 5 });
                        yPos += 5;
                    }

                    renderSection('Referencias Cruzadas', currentAnalysis.cross_references);
                    renderSection('Palabras Clave', currentAnalysis.keywords);
                });

                // 3. GLOBAL PERSONAL NOTES
                if (studyObject.personal_notes) {
                    checkPageBreak(20);
                    yPos += 5;
                    doc.setDrawColor(180, 180, 180);
                    doc.line(MARGIN, yPos, MAX_WIDTH + MARGIN, yPos);
                    yPos += 10;
                    writeText('Notas Personales (Generales)', { fontSize: FONT_SIZES.passageTitle, fontStyle: 'bold', isHeader: true, spaceAfter: 4 });
                    writeText(studyObject.personal_notes, { fontSize: FONT_SIZES.body });
                }

                doc.save(`Estudio - ${studyObject.title.replace(/[:*]/g, '_').substring(0, 50)}.pdf`);
                this.showAlert(`Estudio de "${studyObject.title}" exportado a PDF!`);
            }

            // Renders the generated teaching study
            renderTeachingStudy(data) {
                const teachingHtml = `
                    <div class="analysis-card" id="teaching-study-card">
                        <div class="analysis-card-header">
                            <h3>${data.study_title}</h3>
                            <div class="card-buttons">
                                <button class="copy-btn" data-copy-target="full-teaching-study">Copiar Estudio</button>
                                <button id="export-teaching-study-pdf-btn" class="btn btn-primary" style="font-size: 0.8rem; padding: 0.4rem 0.8rem; width: auto;">Exportar a PDF</button>
                            </div>
                        </div>
                        <div class="card-content" id="full-teaching-study">
                            <h4 class="section-title">Frase Inspiradora <button class="copy-btn" data-copy-target="teaching-phrase">Copiar</button></h4>
                            <blockquote id="teaching-phrase"><p>${this.makeCitationsClickable(data.inspiring_phrase)}</p></blockquote>

                            <h4 class="section-title">Bosquejo para ~1 Hora <button class="copy-btn" data-copy-target="teaching-time">Copiar</button></h4>
                            <p id="teaching-time">${this.makeCitationsClickable(data.time_breakdown)}</p>

                            <h4 class="section-title">Introducción <button class="copy-btn" data-copy-target="teaching-intro">Copiar</button></h4>
                            <div id="teaching-intro">${this.makeCitationsClickable(data.introduction)}</div>

                            <h4 class="section-title">Desarrollo Exegético del Tema <button class="copy-btn" data-copy-target="teaching-development">Copiar</button></h4>
                            <div id="teaching-development">${this.makeCitationsClickable(data.thematic_development)}</div>
                            
                            <h4 class="section-title">Referencias Bíblicas Clave <button class="copy-btn" data-copy-target="teaching-references">Copiar</button></h4>
                            <ul id="teaching-references">${data.key_references.map(q => `<li>${this.makeCitationsClickable(q)}</li>`).join('')}</ul>

                            <h4 class="section-title">Datos Curiosos del Contexto <button class="copy-btn" data-copy-target="teaching-facts">Copiar</button></h4>
                            <ul id="teaching-facts">${data.curious_facts.map(q => `<li>${this.makeCitationsClickable(q)}</li>`).join('')}</ul>

                            <h4 class="section-title">Historia Bíblica Ilustrativa: ${data.biblical_story.title} <button class="copy-btn" data-copy-target="teaching-story">Copiar</button></h4>
                            <div id="teaching-story">
                                <p><em>Referencia: <a href="#" class="devotional-verse-link" data-reference="${data.biblical_story.reference}">${data.biblical_story.reference}</a></em></p>
                                <div>${this.makeCitationsClickable(data.biblical_story.narrative)}</div>
                            </div>

                            <h4 class="section-title">Preguntas y Respuestas Profundas <button class="copy-btn" data-copy-target="teaching-qa">Copiar</button></h4>
                            <div id="teaching-qa">${data.deep_qa.map(qa => `<p><strong>Pregunta:</strong> ${this.makeCitationsClickable(qa.question)}</p><p><strong>Respuesta:</strong> ${this.makeCitationsClickable(qa.answer)}</p>`).join('')}</div>
                            
                            <h4 class="section-title">Puntos Clave de Oración <button class="copy-btn" data-copy-target="teaching-prayer">Copiar</button></h4>
                            <ul id="teaching-prayer">${data.prayer_points.map(q => `<li>${this.makeCitationsClickable(q)}</li>`).join('')}</ul>

                            <h4 class="section-title">Conclusión y Llamado a la Acción <button class="copy-btn" data-copy-target="teaching-conclusion">Copiar</button></h4>
                            <div id="teaching-conclusion">${this.makeCitationsClickable(data.conclusion)}</div>
                        </div>
                    </div>
                `;
                this.dom.teachingResultsContainer.innerHTML = teachingHtml;

                document.getElementById('export-teaching-study-pdf-btn').addEventListener('click', () => {
                    this.exportTeachingStudyToPdf(data);
                });
            }
            
            // Loads the last teaching study from Firestore
            async loadLastTeachingStudy() {
                if (!this.isAuthReady || !this.userId) {
                    console.warn("Firebase no está listo para cargar el último estudio para enseñar.");
                    return;
                }
                const { doc, getDoc } = window.firebase;
                const teachingStudyDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/teachingStudies/lastStudy`);
                try {
                    const docSnap = await getDoc(teachingStudyDocRef);
                    if (docSnap.exists()) {
                        console.log("Cargando el último estudio para enseñar desde Firebase.");
                        this.renderTeachingStudy(docSnap.data());
                    } else {
                        console.log("No se encontró el último estudio para enseñar en Firebase.");
                    }
                } catch (error) {
                    console.error("Error loading last teaching study from Firestore:", error);
                    this.displayError(this.dom.teachingResultsContainer, `Error al cargar el último estudio: ${error.message}`);
                }
            }

            // Exports the teaching study to PDF
            exportTeachingStudyToPdf(studyData) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                const MARGIN = 15;
                const PAGE_WIDTH = doc.internal.pageSize.getWidth();
                const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
                const MAX_WIDTH = PAGE_WIDTH - (2 * MARGIN);
                
                let yPos = MARGIN;

                const checkPageBreak = (requiredHeight) => {
                    if (yPos + requiredHeight > PAGE_HEIGHT - MARGIN) {
                        doc.addPage();
                        yPos = MARGIN;
                    }
                };

                const writeText = (text, options) => {
                    const cleanText = text.replace(/\[\[(.*?)\]\]/g, '$1');
                    const { x = MARGIN, fontStyle = 'normal', fontSize = 11, align = 'left', spaceAfter = 5, color = [0, 0, 0] } = options;
                    doc.setFont('helvetica', fontStyle);
                    doc.setFontSize(fontSize);
                    doc.setTextColor(color[0], color[1], color[2]);
                    const textLines = doc.splitTextToSize(cleanText, MAX_WIDTH - (x - MARGIN));
                    const textHeight = doc.getTextDimensions(textLines).h;
                    checkPageBreak(textHeight);
                    doc.text(textLines, x, yPos, { align: align });
                    yPos += textHeight + spaceAfter;
                };

                const writeHeader = (text) => {
                    yPos += 4;
                    checkPageBreak(12);
                    writeText(text, { fontSize: 14, fontStyle: 'bold', spaceAfter: 6 });
                    doc.setDrawColor(180, 180, 180);
                    doc.line(MARGIN, yPos - 3, MAX_WIDTH + MARGIN, yPos - 3);
                    yPos += 10;
                };

                writeText(studyData.study_title, { fontSize: 20, fontStyle: 'bold', align: 'center', x: PAGE_WIDTH / 2, spaceAfter: 10 });
                writeText(`Basado en: ${this.passagesToStudy.join(', ')}`, { fontSize: 10, fontStyle: 'italic', align: 'center', x: PAGE_WIDTH / 2, spaceAfter: 8 });
                writeText(`"${studyData.inspiring_phrase}"`, { fontSize: 12, fontStyle: 'italic', align: 'center', x: PAGE_WIDTH / 2, spaceAfter: 15 });

                writeHeader('Bosquejo para ~1 Hora');
                writeText(studyData.time_breakdown, {});

                writeHeader('Introducción');
                writeText(studyData.introduction, {});

                writeHeader('Desarrollo Exegético del Tema');
                writeText(studyData.thematic_development, {});

                writeHeader('Referencias Bíblicas Clave');
                studyData.key_references.forEach(q => {
                    writeText(`• ${q}`, { x: MARGIN + 5, spaceAfter: 3 });
                });
                yPos += 5;

                writeHeader('Datos Curiosos del Contexto');
                studyData.curious_facts.forEach(q => {
                    writeText(`• ${q}`, { x: MARGIN + 5, spaceAfter: 3 });
                });
                yPos += 5;
                
                writeHeader(`Historia Bíblica Ilustrativa: ${studyData.biblical_story.title}`);
                writeText(`Referencia: ${studyData.biblical_story.reference}`, {fontStyle: 'italic', fontSize: 10});
                writeText(studyData.biblical_story.narrative, {});

                writeHeader('Preguntas y Respuestas Profundas');
                studyData.deep_qa.forEach(qa => {
                    writeText(`P: ${qa.question}`, {fontStyle: 'bold'});
                    writeText(`R: ${qa.answer}`, {x: MARGIN + 5, spaceAfter: 8});
                });
                yPos += 5;

                writeHeader('Puntos Clave de Oración');
                studyData.prayer_points.forEach(q => {
                    writeText(`• ${q}`, { x: MARGIN + 5, spaceAfter: 3 });
                });
                yPos += 5;

                writeHeader('Conclusión y Llamado a la Acción');
                writeText(studyData.conclusion, {});

                doc.save(`Estudio_para_Enseñar - ${studyData.study_title.replace(/[:*]/g, '_').substring(0, 40)}.pdf`);
                this.showAlert('¡Estudio para enseñar exportado a PDF con éxito!');
            }

            // Resets the current study session state
            resetCurrentStudy() {
                this.currentSessionStudyId = null;
                this.sessionAnalyses = [];
                this.analyzedPassages.clear();
                this.dom.resultsContainer.innerHTML = '';
                if (this.dom.globalPersonalNotes) {
                    this.dom.globalPersonalNotes.value = '';
                }
                // No need to remove from localStorage, as it's handled by Firebase
                this.dom.saveSessionStudyBtn.disabled = true;
                this.dom.exportSessionStudyBtn.disabled = true;
                console.log("Sesión de estudio reseteada.");
            }

            // Initializes global controls (notes, save, export)
            async initializeGlobalControls() {
                await this.loadCurrentStudyNotes();
            }
            
            // Generates reading plans (canonical and meditative)
            generateReadingPlans() {
                const allChapters = [];
                this.BIBLE_BOOKS.forEach(book => {
                    for (let i = 1; i <= book.chapters.length; i++) {
                        allChapters.push(`${book.name} ${i}`);
                    }
                });

                // Canonical Plan
                const canonicalDays = [];
                const totalChapters = allChapters.length;
                const chaptersPerDay = Math.ceil(totalChapters / 365);

                for (let i = 0; i < totalChapters; i += chaptersPerDay) {
                    const chunk = allChapters.slice(i, i + chaptersPerDay);
                    if (chunk.length > 0) {
                        const first = chunk[0];
                        const last = chunk[chunk.length - 1];
                        
                        const firstBook = first.substring(0, first.lastIndexOf(' '));
                        const firstChap = first.substring(first.lastIndexOf(' ') + 1);
                        
                        const lastBook = last.substring(0, last.lastIndexOf(' '));
                        const lastChap = last.substring(last.lastIndexOf(' ') + 1);

                        if (firstBook === lastBook) {
                            canonicalDays.push([`${firstBook} ${firstChap}-${lastChap}`]);
                        } else {
                            const readingsForDay = [];
                            const chaptersByBook = chunk.reduce((acc, curr) => {
                                const bookName = curr.substring(0, curr.lastIndexOf(' '));
                                const chapNum = curr.substring(curr.lastIndexOf(' ') + 1);
                                if (!acc[bookName]) {
                                    acc[bookName] = [];
                                }
                                acc[bookName].push(chapNum);
                                return acc;
                            }, {});

                            for (const book in chaptersByBook) {
                                const chaps = chaptersByBook[book];
                                if (chaps.length === 1) {
                                    readingsForDay.push(`${book} ${chaps[0]}`);
                                } else {
                                    readingsForDay.push(`${book} ${chaps[0]}-${chaps[chaps.length - 1]}`);
                                }
                            }
                            canonicalDays.push(readingsForDay);
                        }
                    }
                }
                
                this.READING_PLANS['one-year-canonical'] = {
                    name: 'Biblia en 1 Año (Canónico)',
                    days: canonicalDays
                };

                // Meditative Plan
                const meditativeDays = [];
                this.BIBLE_BOOKS.forEach(book => {
                    for (let i = 1; i <= book.chapters.length; i++) {
                        meditativeDays.push([`${book.name} ${i}`]);
                    }
                });
                this.READING_PLANS['daily-meditative'] = {
                    name: 'Lectura Diaria para Meditación',
                    days: meditativeDays
                };
            }
            
            // Populates the reading plan selector dropdown
            populatePlanSelector() {
                // Clear existing options except the first one
                while (this.dom.readingPlanSelect.options.length > 1) {
                    this.dom.readingPlanSelect.remove(1);
                }
                for (const planId in this.READING_PLANS) {
                    const option = new Option(this.READING_PLANS[planId].name, planId);
                    this.dom.readingPlanSelect.add(option);
                }
            }

            // Renders the details of a selected reading plan
            async renderReadingPlan(planId) {
                if (!this.isAuthReady || !this.userId) {
                    this.dom.readingPlanDetails.innerHTML = '<p class="error">Firebase no está listo para cargar el progreso del plan de lectura.</p>';
                    return;
                }

                const { doc, getDoc } = window.firebase;
                const planDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/readingPlanProgress`, planId);
                let progress = [];
                try {
                    const docSnap = await getDoc(planDocRef);
                    if (docSnap.exists()) {
                        progress = docSnap.data().completedDays || [];
                    }
                } catch (error) {
                    console.error("Error loading reading plan progress from Firestore:", error);
                    this.displayError(this.dom.readingPlanDetails, `Error al cargar el progreso: ${error.message}`);
                    return;
                }

                const planData = this.READING_PLANS[planId];
                if (!planData) return;

                this.dom.readingPlanDetails.innerHTML = '';
                

                planData.days.forEach((dayReadings, index) => {
                    const dayNumber = index + 1;
                    const isCompleted = progress.includes(dayNumber);

                    const card = document.createElement('div');
                    card.className = `reading-day-card ${isCompleted ? 'completed' : ''}`;
                    card.dataset.dayIndex = dayNumber;

                    let readingsHtml = dayReadings.map(reading => 
                        `<a href="#" class="reading-passage-link" data-passage="${reading}">${reading}</a>`
                    ).join('');

                    card.innerHTML = `
                        <h5>Día ${dayNumber}</h5>
                        <div>${readingsHtml}</div>
                        <div class="card-footer">
                            <button class="btn btn-toggle-complete">
                                ${isCompleted ? '<i class="fas fa-check-circle"></i> Completado' : 'Marcar como Leído'}
                            </button>
                        </div>
                    `;
                    this.dom.readingPlanDetails.appendChild(card);
                });
            }
            
            // Toggles completion status for a reading day
            async toggleReadingDayComplete(planId, dayIndex) {
                if (!this.isAuthReady || !this.userId) {
                    this.showAlert("Firebase no está listo. No se puede actualizar el progreso.");
                    return;
                }

                const { doc, setDoc } = window.firebase;
                const planDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/readingPlanProgress`, planId);
                
                let progress = [];
                try {
                    const docSnap = await getDoc(planDocRef);
                    if (docSnap.exists()) {
                        progress = docSnap.data().completedDays || [];
                    }
                } catch (error) {
                    console.error("Error fetching reading plan progress for toggle:", error);
                    this.showAlert(`Error al actualizar el progreso: ${error.message}`);
                    return;
                }

                const dayNumber = parseInt(dayIndex, 10);
                
                const card = this.dom.readingPlanDetails.querySelector(`[data-day-index="${dayNumber}"]`);
                const button = card.querySelector('.btn-toggle-complete');

                if (progress.includes(dayNumber)) {
                    progress = progress.filter(d => d !== dayNumber);
                    card.classList.remove('completed');
                    button.innerHTML = 'Marcar como Leído';
                } else {
                    progress.push(dayNumber);
                    card.classList.add('completed');
                    button.innerHTML = '<i class="fas fa-check-circle"></i> Completado';
                }

                try {
                    await setDoc(planDocRef, { completedDays: progress }, { merge: true });
                } catch (error) {
                    console.error("Error saving reading plan progress to Firestore:", error);
                    this.showAlert(`Error al guardar el progreso: ${error.message}`);
                }
            }

            // Handles changes in the book selection dropdown
            handleBookChange() {
                this.dom.chapterSelect.innerHTML = '<option value="">Capítulo</option>';
                this.dom.verseContainer.innerHTML = '';
                this.dom.verseSelectorContainer.classList.add('disabled');
                this.dom.chapterSelect.disabled = true;
                this.dom.selectAllCheckbox.checked = false;

                if (this.dom.bookSelect.value !== "") {
                    const book = this.BIBLE_BOOKS[this.dom.bookSelect.value];
                    const chapterCount = book.chapters.length;
                    for (let i = 1; i <= chapterCount; i++) {
                        this.dom.chapterSelect.add(new Option(i, i));
                    }
                    this.dom.chapterSelect.disabled = false;
                }
            }

            // Handles changes in the chapter selection dropdown
            handleChapterChange() {
                const bookIndex = this.dom.bookSelect.value;
                const chapterIndex = parseInt(this.dom.chapterSelect.value, 10) - 1;
                this.dom.verseContainer.innerHTML = '';
                this.dom.selectAllCheckbox.checked = false;
                
                if (bookIndex !== "" && chapterIndex >= 0) {
                    const book = this.BIBLE_BOOKS[bookIndex];
                    let verseCount = book.chapters[chapterIndex];

                    for (let i = 1; i <= verseCount; i++) {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'verse-checkbox-item';
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.id = `verse-${i}`;
                        checkbox.value = i;
                        const label = document.createElement('label');
                        label.htmlFor = `verse-${i}`;
                        label.textContent = i;
                        itemDiv.appendChild(checkbox);
                        itemDiv.appendChild(label);
                        this.dom.verseContainer.appendChild(itemDiv);
                    }
                    this.dom.verseSelectorContainer.classList.remove('disabled');
                } else {
                    this.dom.verseSelectorContainer.classList.add('disabled');
                }
            }

            // Handles "Select All Verses" checkbox
            handleSelectAllVerses() {
                this.dom.verseContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = this.dom.selectAllCheckbox.checked);
            }

            // Adds a selected passage to the study list
            handleAddPassage() {
                if (this.dom.bookSelect.value === "" || this.dom.chapterSelect.value === "") {
                    this.showAlert('Por favor, seleccione un libro y capítulo.');
                    return;
                }
                const bookName = this.BIBLE_BOOKS[this.dom.bookSelect.value].name;
                const chapter = this.dom.chapterSelect.value;
                let verseQuery;
                if (this.dom.selectAllCheckbox.checked) {
                    verseQuery = '*';
                } else {
                    const selected = Array.from(this.dom.verseContainer.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
                    if (selected.length === 0) {
                        this.showAlert('Seleccione al menos un versículo o marque "Seleccionar todo el capítulo".');
                        return;
                    }
                    verseQuery = this.formatVerseQuery(selected);
                }
                const reference = `${bookName} ${chapter}:${verseQuery}`;
                if (!this.passagesToStudy.includes(reference)) {
                    this.passagesToStudy.push(reference);
                    this.updatePassageList();
                }
            }

            // Handles the main passage analysis with AI
            async handleAnalyzePassages() {
                const newPassagesToAnalyze = this.passagesToStudy.filter(p => !this.analyzedPassages.has(p));

                if (newPassagesToAnalyze.length === 0) {
                    this.showAlert('Todos los pasajes en la lista ya han sido analizados. Por favor, añada uno nuevo.');
                    return;
                }
                
                this.dom.analyzeBtn.disabled = true;
                const currentNotes = this.dom.globalPersonalNotes ? this.dom.globalPersonalNotes.value : '';

                this.dom.resultsContainer.innerHTML += '<p class="loading" id="loading-analysis">La IA está analizando los nuevos pasajes. Esto puede tardar un momento...</p>';
                
                const selectedVersions = Array.from(this.dom.versionCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
                const specificTheme = this.dom.analysisThemeInput.value.trim();

                try {
                    let prompt = `Actúa como un teólogo y lingüista bíblico experto. Para la siguiente lista de pasajes [${newPassagesToAnalyze.join(', ')}], realiza estas tareas para CADA pasaje:
1.  **Título del Pasaje**: En el campo "title" del JSON, usa la referencia bíblica exacta del pasaje que estás analizando (ej. "Génesis 1:1-5"). ESTO ES OBLIGATORIO.
2.  **Comparación de Versiones**: Proporciona el texto exacto del pasaje para cada versión en esta lista: [${selectedVersions.join(', ')}].
3.  **Análisis General**: Proporciona el Género Literario, Perfiles de Personajes principales, y una Reflexión Teológica del pasaje.
4.  **Estudio Arqueológico, Cultural e Histórico Profundo**: Proporciona un análisis detallado que incluya:
    a.  **Trasfondo Histórico**: Describe la situación política, social y militar de la época en que se escribió o se desarrollan los eventos del pasaje.
    b.  **Costumbres Culturales**: Explica las normas sociales, tradiciones, vida cotidiana y prácticas culturales relevantes mencionadas o asumidas en el texto.
    c.  **Hallazgos Arqueológicos**: Menciona descubrimientos arqueológicos relevantes (ciudades, artefactos, inscripciones) que corroboren o iluminen el pasaje. Si no hay hallazgos directos, explica el contexto arqueológico general de la región y período.
    d.  **Entorno Geográfico**: Describe la importancia de la ubicación, la geografía y el entorno natural de los eventos del pasaje.
5.  **Palabras Clave**: Identifica 1-3 palabras clave. Para cada una, da la palabra original (hebreo/griego), su significado en español, transliteración, número Strong y una definición expositiva.
6.  **Texto Subrayado**: Usando el texto de la "King James (Español)", reescríbelo, subrayando las palabras clave con la etiqueta <u>.
7.  **Aplicación Práctica**: Escribe 2-3 párrafos sobre cómo aplicar las enseñanzas del pasaje a la vida diaria.
8.  **Bosquejo para Sermón/Estudio**: Genera un bosquejo homilético detallado. Debe incluir un título, una introducción (1-2 párrafos), 3 puntos principales (cada uno con 2-3 subpuntos) y una conclusión (1-2 párrafos).
9.  **Puntos de Oración**: Crea 3-4 puntos de oración basados en la reflexión.
10. **Referencias Cruzadas**: Proporciona 5-7 referencias cruzadas relevantes de otras partes de la Biblia.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.`;
                    
                    if (specificTheme) {
                        prompt += `\n\n**ENFOQUE TEMÁTICO IMPORTANTE**: El usuario ha especificado un tema de enfoque: "${specificTheme}". Asegúrate de que la "Reflexión Teológica", "Aplicación Práctica", "Bosquejo para Sermón/Estudio" y "Puntos de Oración" se centren principalmente en cómo el pasaje ilumina o se relaciona con este tema.`;
                    }

                    prompt += `\n\nDevuelve tu respuesta ÚNICAMENTE como un objeto JSON. La clave principal debe ser "analyses", un array de objetos. Cada objeto debe tener las claves: "title" (que DEBE ser la referencia bíblica del pasaje), "literary_genre", "character_profiles", "version_comparison", "verses_highlighted", "reflection_text", "deeper_context" (un objeto con "historical_background", "cultural_customs", "archaeological_findings", "geographical_setting"), "cross_references", "keywords", "practical_application", "sermon_outline" (un objeto con "title", "introduction", "main_points" [array de objetos con "point" y "subpoints"], y "conclusion"), y "prayer_points". Responde únicamente en español.`;
                    
                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "analyses": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "title": { "type": "STRING" },
                                        "literary_genre": { "type": "STRING" },
                                        "character_profiles": { type: "ARRAY", items: { type: "STRING" } },
                                        "version_comparison": { 
                                            type: "ARRAY", 
                                            items: { 
                                                type: "OBJECT", 
                                                properties: { 
                                                    "version": { "type": "STRING" }, 
                                                    "verses": {
                                                        type: "ARRAY",
                                                        items: {
                                                            type: "OBJECT",
                                                            properties: {
                                                                "verse_number": { "type": "STRING" },
                                                                "text": { "type": "STRING" }
                                                            },
                                                            required: ["verse_number", "text"]
                                                        }
                                                    }
                                                }, 
                                                required: ["version", "verses"] 
                                            } 
                                        },
                                        "verses_highlighted": {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: {
                                                    "verse_number": { "type": "STRING" },
                                                    "verse_text_html": { "type": "STRING" }
                                                },
                                                required: ["verse_number", "verse_text_html"]
                                            }
                                        },
                                        "reflection_text": { "type": "STRING" },
                                        "deeper_context": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "historical_background": { "type": "STRING" },
                                                "cultural_customs": { "type": "STRING" },
                                                "archaeological_findings": { "type": "STRING" },
                                                "geographical_setting": { "type": "STRING" }
                                            },
                                            "required": ["historical_background", "cultural_customs", "archaeological_findings", "geographical_setting"]
                                        },
                                        "cross_references": { type: "ARRAY", items: { "type": "STRING" } },
                                        "keywords": {
                                            type: "ARRAY",
                                            items: {
                                                type: "OBJECT",
                                                properties: { 
                                                    "original_word": { "type": "STRING" }, 
                                                    "spanish_meaning": { "type": "STRING" },
                                                    "transliteration": { "type": "STRING" }, 
                                                    "strong_number": { "type": "STRING" }, 
                                                    "expository_definition": { "type": "STRING" } 
                                                },
                                                required: ["original_word", "spanish_meaning", "transliteration", "strong_number", "expository_definition"]
                                            }
                                        },
                                        "practical_application": { "type": "STRING" },
                                        "sermon_outline": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "title": { "type": "STRING" },
                                                "introduction": { "type": "STRING" },
                                                "main_points": {
                                                    "type": "ARRAY",
                                                    "items": {
                                                        "type": "OBJECT",
                                                        "properties": {
                                                            "point": { "type": "STRING" },
                                                            "subpoints": { "type": "ARRAY", "items": { "type": "STRING" } }
                                                        },
                                                        "required": ["point", "subpoints"]
                                                    }
                                                },
                                                "conclusion": { "type": "STRING" }
                                            },
                                            "required": ["title", "introduction", "main_points", "conclusion"]
                                        },
                                        "prayer_points": { "type": "ARRAY", "items": { "type": "STRING" } }
                                    },
                                    required: ["title", "literary_genre", "character_profiles", "version_comparison", "verses_highlighted", "reflection_text", "deeper_context", "cross_references", "keywords", "practical_application", "sermon_outline", "prayer_points"]
                                }
                            }
                        },
                        required: ["analyses"]
                    };

                    const geminiPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };
                    
                    const geminiData = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });
                    
                    const responseText = geminiData.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(responseText);
                    
                    if (parsedData.analyses && parsedData.analyses.length === newPassagesToAnalyze.length) {
                        parsedData.analyses.forEach((analysis, index) => {
                            analysis.title = newPassagesToAnalyze[index];
                        });
                    } else {
                        console.warn('La cantidad de análisis recibidos no coincide con la cantidad de pasajes enviados. Los títulos podrían ser incorrectos.');
                    }

                    this.sessionAnalyses.push(...parsedData.analyses);
                    newPassagesToAnalyze.forEach(p => this.analyzedPassages.add(p));
                    window.currentAnalyses = this.sessionAnalyses;

                    document.getElementById('loading-analysis')?.remove();

                    this.appendAnalysisResults(parsedData.analyses);
                    this.updatePassageList();
                    
                    if (this.dom.globalPersonalNotes) {
                        this.dom.globalPersonalNotes.value = currentNotes;
                        this.saveCurrentStudyNotes(); // Save notes to Firestore after analysis
                    }

                } catch (error) {
                    console.error('Error en el proceso de análisis:', error);
                    document.getElementById('loading-analysis')?.remove();
                    this.displayError(this.dom.resultsContainer, `Ocurrió un error: ${error.message}. Por favor, intente de nuevo.`);
                } finally {
                    this.dom.analyzeBtn.disabled = false;
                }
            }

            // Handles asking a question to the AI
            async handleAskAI() {
                const question = this.dom.qaInput.value.trim();
                if (!question) {
                    this.showAlert("Por favor, escribe una pregunta.");
                    return;
                }
                this.displayLoading(this.dom.qaResultsContainer, 'La IA está pensando en tu respuesta...');
                const prompt = `Actúa como un teólogo experto y responde a la siguiente pregunta basándote en un análisis bíblico completo.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.
La pregunta es: "${question}". Responde únicamente en español.`;
                try {
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const responseText = data.candidates[0].content.parts[0].text;
                    this.dom.qaResultsContainer.innerHTML = `<div class="analysis-card"><div class="card-header"><h4>Respuesta de la IA <button class="copy-btn" data-copy-target="qa-response">Copiar</button></h4></div><div class="card-content" id="qa-response" style="white-space: pre-wrap;">${this.makeCitationsClickable(responseText)}</div></div>`;
                } catch (error) {
                    this.displayError(this.dom.qaResultsContainer, `Error al obtener respuesta: ${error.message}`);
                }
            }
            
            // Handles defining a word with AI
            async handleDefineWord() {
                const word = this.dom.dictionaryInput.value.trim();
                if (!word) {
                    this.showAlert("Por favor, escribe una palabra para definir.");
                    return;
                }
                this.displayLoading(this.dom.dictionaryResultsContainer, 'La IA está generando la definición expositiva...');
                const prompt = `Actúa como un diccionario teológico expositivo. Proporciona una definición detallada para el término "${word}". Tu respuesta debe tener dos secciones principales: "En el Antiguo Testamento" y "En el Nuevo Testamento". Para cada sección, explica el significado, el uso y el contexto del término. Incluye la(s) palabra(s) hebrea(s) o griega(s) más relevantes, su transliteración y su número Strong.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.
Responde únicamente en español.`;
                try {
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const responseText = data.candidates[0].content.parts[0].text;
                    this.dom.dictionaryResultsContainer.innerHTML = `<div class="analysis-card"><div class="card-header"><h4>Definición de "${word}" <button class="copy-btn" data-copy-target="dictionary-definition">Copiar</button></h4></div><div class="card-content" id="dictionary-definition" style="white-space: pre-wrap;">${this.makeCitationsClickable(responseText)}</div></div>`;
                } catch (error) {
                    this.displayError(this.dom.dictionaryResultsContainer, `Error al obtener definición: ${error.message}`);
                }
            }

            // Handles thematic analysis with AI
            async handleAnalyzeTheme() {
                const theme = this.dom.thematicInput.value.trim();
                if (!theme) {
                    this.showAlert("Por favor, escribe un tema para analizar.");
                    return;
                }

                this.displayLoading(this.dom.thematicResultsContainer, 'La IA está realizando el análisis temático. Esto puede tardar un momento...');

                try {
                    const prompt = `Actúa como un teólogo experto en estudios bíblicos temáticos. Realiza un análisis transversal exhaustivo sobre el tema "${theme}" a lo largo de toda la Biblia. Tu análisis debe incluir:
1.  Una introducción al tema.
2.  Una sección detallada sobre cómo se desarrolla el tema en el Antiguo Testamento.
3.  Una sección detallada sobre cómo se desarrolla el tema en el Nuevo Testamento.
4.  Un resumen del significado teológico global del tema.
5.  Una sección de aplicación práctica para la vida del creyente hoy.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.
Devuelve tu respuesta ÚNICAMENTE como un objeto JSON. La clave principal debe ser "thematic_analysis" con las siguientes claves anidadas: "theme_title", "introduction", y "sections" (un array de objetos). Cada objeto en "sections" debe tener las claves "title", "content", y "key_passages" (un array de strings). Responde únicamente en español.`;

                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "thematic_analysis": {
                                type: "OBJECT",
                                properties: {
                                    "theme_title": { "type": "STRING" },
                                    "introduction": { "type": "STRING" },
                                    "sections": {
                                        type: "ARRAY",
                                        items: {
                                            type: "OBJECT",
                                            properties: {
                                                "title": { "type": "STRING" },
                                                "content": { "type": "STRING" },
                                                "key_passages": { type: "ARRAY", items: { "type": "STRING" } }
                                            },
                                            required: ["title", "content", "key_passages"]
                                        }
                                    }
                                },
                                required: ["theme_title", "introduction", "sections"]
                            }
                        },
                        required: ["thematic_analysis"]
                    };

                    const geminiPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };

                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });

                    const thematicAnalysisData = JSON.parse(data.candidates[0].content.parts[0].text).thematic_analysis;

                    let sectionsHtml = '';
                    thematicAnalysisData.sections.forEach(section => {
                        sectionsHtml += `
                            <h4 class="section-title">${section.title} <button class="copy-btn" data-copy-target="theme-section-${section.title.replace(/\s+/g, '-').toLowerCase()}">Copiar</button></h4>
                            <div id="theme-section-${section.title.replace(/\s+/g, '-').toLowerCase()}">
                                <p>${this.makeCitationsClickable(section.content)}</p>
                                <p><strong>Pasajes clave:</strong> ${this.makeCitationsClickable(section.key_passages.join(', '))}</p>
                            </div>
                        `;
                    });

                    const thematicHtml = `
                        <div class="analysis-card">
                            <div class="card-header">
                                <h4>Análisis Temático: ${thematicAnalysisData.theme_title} <button class="copy-btn" data-copy-target="thematic-analysis-full">Copiar</button></h4>
                            </div>
                            <div class="card-content" id="thematic-analysis-full">
                                <h4 class="section-title">Introducción <button class="copy-btn" data-copy-target="theme-introduction">Copiar</button></h4>
                                <p id="theme-introduction">${this.makeCitationsClickable(thematicAnalysisData.introduction)}</p>
                                ${sectionsHtml}
                            </div>
                        </div>
                    `;
                    this.dom.thematicResultsContainer.innerHTML = thematicHtml;

                } catch (error) {
                    console.error('Error en el análisis temático:', error);
                    this.displayError(this.dom.thematicResultsContainer, `Error al realizar el análisis temático: ${error.message}`);
                }
            }

            // Handles generating study questions and answers
            async handleGenerateQuestions() {
                const passage = this.dom.questionGeneratorInput.value.trim();
                if (!passage) {
                    this.showAlert("Por favor, introduce un pasaje bíblico para generar preguntas.");
                    return;
                }

                this.displayLoading(this.dom.questionGeneratorResultsContainer, 'La IA está generando preguntas y respuestas de estudio...');

                try {
                    const prompt = `Actúa como un líder de estudio bíblico y teólogo. Para el pasaje bíblico: "${passage}", genera 5-7 preguntas de estudio profundas y reflexivas. Para cada pregunta, proporciona una respuesta bien fundamentada, basada en el texto y el contexto bíblico.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.
Devuelve tu respuesta ÚNICAMENTE como un objeto JSON con la clave 'qa_pairs', un array de objetos. Cada objeto debe tener las claves 'question' y 'answer'. Responde únicamente en español.`;

                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "qa_pairs": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "question": { "type": "STRING" },
                                        "answer": { "type": "STRING" }
                                    },
                                    "required": ["question", "answer"]
                                }
                            }
                        },
                        required: ["qa_pairs"]
                    };

                    const geminiPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };

                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });

                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
                        throw new Error("La respuesta de la IA no tuvo el formato esperado.");
                    }
                    const responseText = data.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(responseText);
                    const qaData = parsedData.qa_pairs;

                    if (!qaData || !Array.isArray(qaData)) {
                             throw new Error("La estructura de preguntas y respuestas de la IA es inválida.");
                    }

                    let qaHtml = `<div class="analysis-card"><div class="card-header"><h4>Preguntas y Respuestas para "${passage}" <button class="copy-btn" data-copy-target="study-questions">Copiar</button></h4></div><div class="card-content" id="study-questions">`;
                    qaData.forEach(qa => {
                        qaHtml += `
                            <div class="qa-pair" style="margin-bottom: 1.5rem;">
                                <p><strong>Pregunta:</strong> ${this.makeCitationsClickable(qa.question)}</p>
                                <p><strong>Respuesta:</strong> ${this.makeCitationsClickable(qa.answer)}</p>
                            </div>
                        `;
                    });
                    qaHtml += `</div></div>`;
                    this.dom.questionGeneratorResultsContainer.innerHTML = qaHtml;

                } catch (error) {
                    console.error('Error al generar preguntas y respuestas:', error);
                    this.displayError(this.dom.questionGeneratorResultsContainer, `Error al generar el material de estudio: ${error.message}`);
                }
            }

            // Handles quick concordance search
            async handleConcordanceSearch() {
                const word = this.dom.concordanceInput.value.trim();
                if (!word) {
                    this.showAlert("Por favor, introduce una palabra para buscar en la concordancia.");
                    return;
                }

                this.displayLoading(this.dom.concordanceResultsContainer, 'La IA está buscando la palabra en la Biblia...');

                try {
                    const prompt = `Actúa como una concordancia bíblica. Para la palabra "${word}", lista 5-10 versículos de la Biblia (King James en español) donde aparezca, junto con el texto completo del versículo. Prioriza versículos que muestren el uso significativo de la palabra.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.
Devuelve tu respuesta ÚNICAMENTE como un objeto JSON con la clave 'occurrences', un array de objetos. Cada objeto debe tener las claves 'reference' y 'verse_text'. Responde únicamente en español.`;

                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "occurrences": {
                                "type": "ARRAY",
                                "items": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "reference": { "type": "STRING" },
                                        "verse_text": { "type": "STRING" }
                                    },
                                    "required": ["reference", "verse_text"]
                                }
                            }
                        },
                        required: ["occurrences"]
                    };

                    const geminiPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };

                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });
                    const occurrencesData = JSON.parse(data.candidates[0].content.parts[0].text).occurrences;

                    let occurrencesHtml = `<div class="analysis-card"><div class="card-header"><h4>Resultados de concordancia para "${word}" <button class="copy-btn" data-copy-target="concordance-results">Copiar</button></h4></div><div class="card-content" id="concordance-results"><ul>`;
                    if (occurrencesData.length > 0) {
                        occurrencesData.forEach(occ => {
                            occurrencesHtml += `<li><strong>${occ.reference}:</strong> ${this.makeCitationsClickable(occ.verse_text)}</li>`;
                        });
                    } else {
                        occurrencesHtml += `<li>No se encontraron versículos para la palabra "${word}".</li>`;
                    }
                    occurrencesHtml += `</ul></div></div>`;
                    this.dom.concordanceResultsContainer.innerHTML = occurrencesHtml;

                } catch (error) {
                    console.error('Error en la búsqueda de concordancia:', error);
                    this.displayError(this.dom.concordanceResultsContainer, `Error al buscar en la concordancia: ${error.message}`);
                }
            }

            // Helper function to get the day of the year (1-365)
            getDayOfYear(date) {
                const start = new Date(date.getFullYear(), 0, 0);
                const diff = (date - start) + ((start.getTimezoneOffset() - date.getTimezoneOffset()) * 60 * 1000);
                const oneDay = 1000 * 60 * 60 * 24;
                return Math.floor(diff / oneDay);
            }

            // Loads used devotional references from Firestore
            async loadUsedDevotionalReferences() {
                if (!this.isAuthReady || !this.userId) {
                    console.warn("Firebase no está listo para cargar referencias de devocionales.");
                    return;
                }
                const { doc, getDoc } = window.firebase;
                const devotionalHistoryDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/devotionalHistory/references`);
                try {
                    const docSnap = await getDoc(devotionalHistoryDocRef);
                    if (docSnap.exists()) {
                        this.usedDevotionalReferences = docSnap.data().references || [];
                    } else {
                        this.usedDevotionalReferences = [];
                    }
                } catch (error) {
                    console.error("Error loading used devotional references from Firestore:", error);
                    this.usedDevotionalReferences = []; // Reset on error
                }
                this.cleanOldUsedReferences();
                console.log("Referencias de devocionales cargadas:", this.usedDevotionalReferences.length);
            }

            // Saves used devotional references to Firestore
            async saveUsedDevotionalReferences() {
                if (!this.isAuthReady || !this.userId) {
                    console.warn("Firebase no está listo para guardar referencias de devocionales.");
                    return;
                }
                const { doc, setDoc } = window.firebase;
                const devotionalHistoryDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/devotionalHistory/references`);
                try {
                    await setDoc(devotionalHistoryDocRef, {
                        references: this.usedDevotionalReferences,
                        last_updated: new Date().toISOString()
                    }, { merge: true });
                    console.log("Referencias de devocionales guardadas. Cantidad:", this.usedDevotionalReferences.length);
                } catch (error) {
                    console.error("Error saving used devotional references to Firestore:", error);
                }
            }

            // Cleans references older than 5 months (approx. 150 days)
            cleanOldUsedReferences() {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - 150); // 150 days ≈ 5 months

                const initialLength = this.usedDevotionalReferences.length;
                this.usedDevotionalReferences = this.usedDevotionalReferences.filter(entry => {
                    return new Date(entry.date) > cutoffDate;
                });
                if (this.usedDevotionalReferences.length !== initialLength) {
                    this.saveUsedDevotionalReferences();
                    console.log(`Se eliminaron ${initialLength - this.usedDevotionalReferences.length} referencias antiguas.`);
                }
            }

            // Displays a single devotional (morning or night)
            async renderSingleDevotional(devotionalData, type) {
                const containerId = `devotional-${type}-container`;
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Error: Contenedor ${containerId} no encontrado.`);
                    return;
                }

                const clickableIntroduction = this.makeCitationsClickable(devotionalData.introduction);
                const clickableReflection = this.makeCitationsClickable(devotionalData.reflection);

                container.innerHTML = `
                    <div class="analysis-card">
                        <div class="card-header"><h4>Devocional de la ${type === 'morning' ? 'Mañana' : 'Noche'}: ${devotionalData.reference} <button class="copy-btn" data-copy-target="${type}-devotional-content">Copiar</button></h4></div>
                        <div class="card-content" id="${type}-devotional-content">
                            <h4 class="section-title">Pasaje</h4><blockquote>${this.makeCitationsClickable(devotionalData.verse_text)}</blockquote>
                            <h4 class="section-title">Tiempo Sugerido (30-45 min)</h4><p>${devotionalData.suggested_time_breakdown}</p>
                            <h4 class="section-title">Introducción</h4><div>${clickableIntroduction}</div>
                            <h4 class="section-title">Reflexión</h4><div>${clickableReflection}</div>
                            <h4 class="section-title">Palabra Clave del Día</h4><p>${devotionalData.keyword_of_day || 'N/A'}</p>
                            <h4 class="section-title">Versículo para Memorizar</h4><p><em>${devotionalData.verse_to_memorize || 'N/A'}</em></p>
                            <h4 class="section-title">Preguntas para Meditar</h4><ul>${devotionalData.questions.map(q => `<li>${this.makeCitationsClickable(q)}</li>`).join('')}</ul>
                            <h4 class="section-title">Oración</h4><p><em>${this.makeCitationsClickable(devotionalData.prayer)}</em></p>
                            <h4 class="section-title">Desafío de Aplicación</h4><p>${this.makeCitationsClickable(devotionalData.application_challenge)}</p>
                            <h4 class="section-title">Puntos de Discusión</h4><ul>${devotionalData.discussion_points.map(p => `<li>${this.makeCitationsClickable(p)}</li>`).join('')}</ul>
                            <h4 class="section-title">Canto Sugerido</h4><p>${devotionalData.suggested_song_title || 'N/A'}</p>
                        </div>
                    </div>`;
            }

            // Handles generating daily devotionals
            async handleGenerateDevotional(event) {
                if (!this.isAuthReady || !this.userId) {
                    this.showAlert("Firebase no está listo. No se pueden generar devocionales.");
                    return;
                }

                const today = new Date();
                const todayISO = today.toISOString().slice(0, 10);
                const { doc, getDoc, setDoc } = window.firebase;
                const dailyDevotionalsDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/dailyDevotionals/today`);
                
                let storedDailyDevotionals = null;
                try {
                    const docSnap = await getDoc(dailyDevotionalsDocRef);
                    if (docSnap.exists()) {
                        storedDailyDevotionals = docSnap.data();
                    }
                } catch (error) {
                    console.error("Error loading daily devotionals from Firestore:", error);
                    // Continue as if no data was found, forcing generation
                }

                const forceNew = event.target.id === 'force-generate-devotional-btn';

                console.log(`Botón pulsado: ${event.target.id}`);

                this.dom.devotionalOverallStatus.innerHTML = '';
                this.displayLoading(this.dom.devotionalMorningContainer, 'Cargando devocional de la mañana...');
                this.displayLoading(this.dom.devotionalNightContainer, 'Cargando devocional de la noche...');

                if (storedDailyDevotionals && storedDailyDevotionals.date === todayISO && !forceNew) {
                    console.log("Cargando devocionales de hoy desde Firebase (mismo día).");
                    this.dom.devotionalOverallStatus.innerHTML = '<p class="loading">Devocionales de hoy cargados desde el historial.</p>';
                    await this.renderSingleDevotional(storedDailyDevotionals.morning, 'morning');
                    await this.renderSingleDevotional(storedDailyDevotionals.night, 'night');
                    return;
                }

                console.log("Generando nuevos devocionales...");
                this.dom.devotionalOverallStatus.innerHTML = '<p class="loading">Generando tus devocionales diarios (mañana y noche)... Esto puede tardar un momento.</p>';
                
                const dayOfYear = this.getDayOfYear(today);
                const themeIndex = (dayOfYear - 1) % this.DAILY_DEVOTIONAL_THEMES.length;
                const dailyTheme = this.DAILY_DEVOTIONAL_THEMES[themeIndex];

                const recentReferences = this.usedDevotionalReferences.map(entry => entry.reference);
                const explicitAvoids = ["Filipenses 4:6-7", "1 Pedro 5:7", "Salmo 4:8"];
                const combinedAvoidList = [...new Set([...recentReferences, ...explicitAvoids])];
                const avoidListPrompt = combinedAvoidList.length > 0 ? ` Evita a toda costa los siguientes pasajes o sus ideas centrales: [${combinedAvoidList.join(', ')}].` : '';

                const prompt = `Actúa como un escritor de devocionales experimentado y creativo. Para el tema del día: "${dailyTheme}", necesitas proveer dos devocionales COMPLETAMENTE DISTINTOS: uno para la mañana, con un enfoque inspirador o de inicio de día, y otro para la noche, con un enfoque de reflexión o cierre. Es CRÍTICO que los pasajes bíblicos usados sean diferentes entre sí (para mañana y noche) y que los temas, aunque relacionados con principios cristianos, ofrezcan una perspectiva fresca para cada momento del día. Asegúrate de que los pasajes seleccionados sean frescos y variados, evitando pasajes comunes o recientemente usados como "Filipenses 4:6-7" o "1 Pedro 5:7". Para el devocional de la noche, asegúrate de seleccionar un pasaje y un tema que no sea el mismo del devocional de la mañana y que NO sea Salmo 4:8. Evita a toda costa repetir Salmo 4:8 en cualquier devocional. Selecciona pasajes de la Biblia con la mayor diversidad posible, para asegurar variedad a lo largo del tiempo. Cada devocional debe incluir:
1.  Un pasaje bíblico corto (2-4 versículos).
2.  Una introducción al tema.
3.  Una reflexión más profunda (2-3 párrafos).
4.  2-3 preguntas para meditación personal.
5.  Una oración final.
6.  Una 'suggested_time_breakdown' que sugiera cómo usar 30-45 minutos para este devocional (ej. "Lectura del pasaje: 5 min; Reflexión y meditación: 15-20 min; Oración: 10 min; Aplicación: 5-10 min").
7.  Un 'application_challenge' (string) que proponga un desafío práctico para el día.
8.  Un array de 'discussion_points' (3-5 strings) para fomentar la conversación en grupo.
9.  Una 'keyword_of_day' (string) que identifique una palabra o concepto clave del devocional.
10. Un 'verse_to_memorize' (string) que sea un versículo clave del devocional.
11. Un 'suggested_song_title' (string) que sugiera un título de canto o himno relevante.
**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]) en CUALQUIER campo de texto, debes envolverla en dobles corchetes. Esto es esencial para la funcionalidad.
Devuelve tu respuesta ÚNICAMENTE como un array de dos objetos JSON. Cada objeto debe tener las claves "reference", "verse_text", "introduction", "reflection", "questions" (an array de strings), "prayer", "suggested_time_breakdown", "application_challenge", "discussion_points", "keyword_of_day", "verse_to_memorize", y "suggested_song_title". Responde únicamente en español.`;

                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "reference": { "type": "STRING" },
                            "verse_text": { "type": "STRING" },
                            "introduction": { "type": "STRING" },
                            "reflection": { "type": "STRING" },
                            "questions": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "prayer": { "type": "STRING" },
                            "suggested_time_breakdown": { "type": "STRING" },
                            "application_challenge": { "type": "STRING" },
                            "discussion_points": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "keyword_of_day": { "type": "STRING" },
                            "verse_to_memorize": { "type": "STRING" },
                            "suggested_song_title": { "type": "STRING" }
                        },
                        required: ["reference", "verse_text", "introduction", "reflection", "questions", "prayer", "suggested_time_breakdown", "application_challenge", "discussion_points", "keyword_of_day", "verse_to_memorize", "suggested_song_title"]
                    },
                    minItems: 2,
                    maxItems: 2  
                };
                
                try {
                    // fetchWithRetry already returns the JSON parsed data
                    const devotionalArray = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema }})
                    });

                    // The response from fetchWithRetry is already the parsed JSON object.
                    // So, we need to access the candidates directly.
                    const parsedDevotionalData = JSON.parse(devotionalArray.candidates[0].content.parts[0].text);

                    if (!Array.isArray(parsedDevotionalData) || parsedDevotionalData.length !== 2) {
                        throw new Error("Formato de respuesta inesperado de la IA para devocionales. Se esperaban 2 devocionales.");
                    }

                    const morningDevotional = parsedDevotionalData[0];
                    const nightDevotional = parsedDevotionalData[1];

                    const generatedReferences = [morningDevotional.reference, nightDevotional.reference];
                    const hasRepetition = generatedReferences.some(ref => 
                        this.usedDevotionalReferences.some(usedRef => usedRef.reference === ref)
                    );

                    if (hasRepetition && !forceNew) {
                        this.displayError(this.dom.devotionalOverallStatus, `Se detectó un pasaje repetido en los devocionales generados. Por favor, intente de nuevo o use "Generar Nuevos Devocionales (Ignorar Historial)" para forzar una nueva selección.`);
                        this.dom.devotionalMorningContainer.innerHTML = '';
                        this.dom.devotionalNightContainer.innerHTML = '';
                        return;
                    }

                    // Save to Firestore
                    await setDoc(dailyDevotionalsDocRef, {
                        date: todayISO,
                        morning: morningDevotional,
                        night: nightDevotional
                    });

                    this.usedDevotionalReferences.push({ reference: morningDevotional.reference, date: todayISO });
                    this.usedDevotionalReferences.push({ reference: nightDevotional.reference, date: todayISO });
                    await this.saveUsedDevotionalReferences(); // Save updated list to Firestore

                    this.dom.devotionalOverallStatus.innerHTML = '';

                    await this.renderSingleDevotional(morningDevotional, 'morning');
                    await this.renderSingleDevotional(nightDevotional, 'night');

                } catch (error) {
                    console.error('Error al generar devocionales:', error);
                    this.displayError(this.dom.devotionalOverallStatus, `Error al generar devocionales: ${error.message}. Por favor, intente de nuevo.`);
                    this.dom.devotionalMorningContainer.innerHTML = '';
                    this.dom.devotionalNightContainer.innerHTML = '';
                }
            }

            // Handles generating a teaching study
            async handleGenerateTeachingStudy() {
                if (!this.isAuthReady || !this.userId) {
                    this.showAlert("Firebase no está listo. No se puede generar el estudio para enseñar.");
                    return;
                }

                const theme = this.dom.teachingThemeInput.value.trim();
                if (this.passagesToStudy.length === 0) {
                    this.showAlert('Por favor, añada al menos un pasaje en el "Paso 1" para generar el estudio.');
                    return;
                }
                if (!theme) {
                    this.showAlert('Por favor, ingrese un tema central para la enseñanza.');
                    return;
                }

                this.displayLoading(this.dom.teachingResultsContainer, 'La IA está preparando su estudio para enseñar. Este proceso es profundo y puede tardar unos momentos...');

                try {
                    const prompt = `
                    Actúa como un pastor y teólogo experto en la preparación de material de enseñanza bíblica para grupos grandes. Tu tarea es crear un estudio profundo y atractivo sobre el tema "${theme}", basado en los siguientes pasajes: [${this.passagesToStudy.join(', ')}].

                    El estudio debe ser completo, fácil de seguir para un maestro, y estar diseñado para una duración total de aproximadamente una hora (50-60 minutos). La estructura debe ser la siguiente:
                    1.  **study_title**: Un título creativo y atractivo para la enseñanza.
                    2.  **inspiring_phrase**: Una frase corta, inspiradora y reflexiva que capture la esencia del tema.
                    3.  **time_breakdown**: Un desglose de tiempo sugerido para cada sección, sumando un total de aproximadamente una hora (50-60 minutos) (ej. "Introducción: 5 min; Desarrollo Exegético: 20 min; Historia Ilustrativa: 15 min; P&R y Aplicación: 15 min; Conclusión y Oración: 5 min").
                    4.  **introduction**: Una introducción cautivadora (2-3 párrafos) que presente el tema y genere interés.
                    5.  **thematic_development**: Un análisis exegético profundo del tema (4-6 párrafos). Conecta los pasajes seleccionados, explicando cómo cada uno contribuye a la comprensión del tema central. Cuando sea relevante, menciona palabras clave en hebreo o griego (con su transliteración y significado) para enriquecer el análisis.
                    6.  **key_references**: Un array de 3-5 referencias bíblicas clave (solo la cita, ej., "Juan 3:16-17") que son fundamentales para el tema.
                    7.  **curious_facts**: Un array de 2-3 "datos curiosos" o puntos de contexto histórico/cultural breves y relevantes que enriquezcan la comprensión.
                    8.  **biblical_story**: Una historia bíblica que ilustre vívidamente el tema. No tiene que ser de los pasajes seleccionados, pero debe ser muy relevante. Debe incluir:
                            * **title**: El título de la historia (ej. "David y Goliat: Fe ante lo imposible").
                            * **reference**: La cita bíblica de la historia.
                            * **narrative**: La historia re-narrada de forma atractiva y concisa (2-4 párrafos), destacando la conexión con el tema principal.
                    9.  **deep_qa**: Una sección de Preguntas y Respuestas. Debe ser un array de 2-3 objetos, donde cada objeto tiene una 'question' (una pregunta profunda o difícil sobre el tema) y una 'answer' (una respuesta teológicamente sólida y bien fundamentada).
                    10. **prayer_points**: Un array de 3-4 puntos clave y específicos para guiar un tiempo de oración al final del estudio.
                    11. **conclusion**: Una conclusión poderosa (2 párrafos) que resuma los puntos clave y termine con un llamado a la acción claro y motivador.

                    **REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]], [[1 Samuel 17:1-10]]) en CUALQUIER campo de texto de tu respuesta (introduction, thematic_development, narrative, etc.), debes envolverla en dobles corchetes.

                    Devuelve tu respuesta ÚNICAMENTE como un objeto JSON, siguiendo estrictamente el esquema proporcionado. Responde únicamente en español.`;

                    const schema = {
                        type: "OBJECT",
                        properties: {
                            "study_title": { "type": "STRING" },
                            "inspiring_phrase": { "type": "STRING" },
                            "time_breakdown": { "type": "STRING" },
                            "introduction": { "type": "STRING" },
                            "thematic_development": { "type": "STRING" },
                            "key_references": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "curious_facts": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "biblical_story": {
                                type: "OBJECT",
                                properties: {
                                    "title": { "type": "STRING" },
                                    "reference": { "type": "STRING" },
                                    "narrative": { "type": "STRING" }
                                },
                                required: ["title", "reference", "narrative"]
                            },
                            "deep_qa": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    "properties": {
                                        "question": { "type": "STRING" },
                                        "answer": { "type": "STRING" }
                                    },
                                    required: ["question", "answer"]
                                }
                            },
                            "prayer_points": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "conclusion": { "type": "STRING" }
                        },
                        required: ["study_title", "inspiring_phrase", "time_breakdown", "introduction", "thematic_development", "key_references", "curious_facts", "biblical_story", "deep_qa", "prayer_points", "conclusion"]
                    };

                    const geminiPayload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json", responseSchema: schema }
                    };

                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(geminiPayload)
                    });

                    const parsedData = JSON.parse(data.candidates[0].content.parts[0].text);
                    
                    // Save to Firestore
                    const { doc, setDoc } = window.firebase;
                    const teachingStudyDocRef = doc(this.db, `artifacts/${this.appId}/users/${this.userId}/teachingStudies/lastStudy`);
                    await setDoc(teachingStudyDocRef, parsedData);
                    console.log("Estudio para enseñar guardado en Firebase.");

                    this.renderTeachingStudy(parsedData);

                } catch (error) {
                    console.error('Error generando el estudio para enseñar:', error);
                    this.displayError(this.dom.teachingResultsContainer, `Ocurrió un error al generar el estudio: ${error.message}. Por favor, revise el tema o los pasajes y vuelva a intentarlo.`);
                }
            }

            // Handles the deep keyword study
            async handleKeywordStudy(word, translit, strong) {
                this.openGenericModal(`Estudio de: ${word} (${translit})`, '<p class="loading">✨ Realizando estudio expositivo de la palabra... ✨</p>');

                const prompt = `Actúa como un erudito bíblico y lingüista. Realiza un estudio expositivo profundo sobre la palabra con el número de Strong "${strong}" (palabra original: ${word}, transliteración: ${translit}). La respuesta debe ser completa y bien estructurada. Incluye las siguientes secciones:
1.  **Definición Concisa**: Una definición clara y directa del término.
2.  **Raíz Etimológica**: Explica la raíz de la palabra y su significado fundamental.
3.  **Uso en el Antiguo Testamento**: Describe cómo se usa la palabra en el AT, sus matices y proporciona 2-3 ejemplos de versículos clave.
4.  **Uso en el Nuevo Testamento (o Septuaginta si es palabra hebrea)**: Describe cómo se traduce o se usa el concepto en el NT, sus matices y proporciona 2-3 ejemplos de versículos clave.
5.  **Rango Semántico**: Explica las diferentes formas o significados que la palabra puede adoptar según el contexto.
6.  **Importancia Teológica**: Resume la importancia teológica de esta palabra para la doctrina cristiana.

**REGLA CRÍTICA**: Cada vez que cites una referencia bíblica (ej. [[Juan 3:16]]), debes envolverla en dobles corchetes.
Devuelve tu respuesta como un texto bien formateado con títulos para cada sección. Responde únicamente en español.`;

                try {
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const responseText = data.candidates[0].content.parts[0].text;
                    this.dom.genericModalBody.innerHTML = this.makeCitationsClickable(responseText.replace(/\n/g, '<br>'));
                } catch (error) {
                    this.displayError(this.dom.genericModalBody, `Error al obtener el estudio de la palabra: ${error.message}`);
                }
            }

            // Handles generating sermon illustrations
            async handleGenerateIllustrations(analysisIndex) {
                const sermon = this.sessionAnalyses[analysisIndex].sermon_outline;
                if (!sermon) return;

                this.openGenericModal(`Ilustraciones para: ${sermon.title}`, '<p class="loading">✨ La IA está buscando ilustraciones y analogías... ✨</p>');

                const prompt = `Actúa como un pastor experimentado y un excelente comunicador. Para el siguiente bosquejo de sermón, genera 2 o 3 ilustraciones o analogías atractivas y relevantes para una audiencia contemporánea. Las ilustraciones deben ayudar a explicar y dar vida a los puntos principales.
- **Título del Sermón**: ${sermon.title}
- **Puntos Principales**: ${sermon.main_points.map(p => p.point).join('; ')}

Proporciona ilustraciones claras, concisas y fáciles de entender. Pueden ser historias cortas, analogías de la vida cotidiana o ejemplos históricos.
**REGLA CRÍTICA**: Si citas una referencia bíblica, envuélvela en dobles corchetes, como [[Filipenses 4:13]].
Responde únicamente en español.`;

                try {
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const responseText = data.candidates[0].content.parts[0].text;
                    this.dom.genericModalBody.innerHTML = this.makeCitationsClickable(responseText.replace(/\n/g, '<br>'));
                } catch (error) {
                    this.displayError(this.dom.genericModalBody, `Error al generar ilustraciones: ${error.message}`);
                }
            }

            // Handles generating character dialogues
            async handleGenerateDialogue(analysisIndex, characterIndex) {
                const analysis = this.sessionAnalyses[analysisIndex];
                const characterProfile = analysis.character_profiles[characterIndex];
                if (!characterProfile) return;

                const characterName = characterProfile.split(':')[0];
                const passageContext = analysis.title;

                this.openGenericModal(`Diálogo Ficticio para ${characterName}`, '<p class="loading">✨ La IA está escribiendo un diálogo creativo... ✨</p>');

                const prompt = `Actúa como un talentoso escritor de ficción histórica y teólogo. Basado en el siguiente perfil de personaje y el contexto bíblico, escribe un monólogo corto y creativo en primera persona (150-250 palabras) desde la perspectiva de este personaje. El monólogo debe ser emocionalmente resonante, psicológicamente creíble y teológicamente consistente con el carácter del personaje y los eventos del pasaje.
- **Personaje**: ${characterName}
- **Contexto del Pasaje**: ${passageContext}
- **Perfil del Personaje**: ${characterProfile}

El diálogo debe reflejar los posibles pensamientos, miedos, esperanzas o luchas internas del personaje en ese momento específico de la narrativa.
**REGLA CRÍTICA**: Si citas una referencia bíblica, envuélvela en dobles corchetes, como [[Salmos 23:1]].
Responde únicamente en español.`;

                try {
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const responseText = data.candidates[0].content.parts[0].text;
                    this.dom.genericModalBody.innerHTML = this.makeCitationsClickable(responseText.replace(/\n/g, '<br>'));
                } catch (error) {
                    this.displayError(this.dom.genericModalBody, `Error al generar el diálogo: ${error.message}`);
                }
            }

            // Handles generating a timeline (placeholder for now)
            async handleGenerateTimeline(analysisIndex) {
                const analysisTitle = this.sessionAnalyses[analysisIndex].title;
                this.openGenericModal(`Línea de Tiempo para: ${analysisTitle}`, '<p class="loading">✨ Generando línea de tiempo... ✨</p>');
                
                const prompt = `Genera una línea de tiempo concisa de 5-7 eventos históricos clave relacionados con el pasaje bíblico "${analysisTitle}". Para cada evento, incluye:
1.  **Año/Período**: El año o rango de años.
2.  **Evento**: Una descripción breve del evento.
3.  **Relevancia**: Cómo se relaciona con el pasaje.
Devuelve tu respuesta como un array de objetos JSON, donde cada objeto tiene las claves "year_period", "event", y "relevance". Responde únicamente en español.`;

                const schema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "year_period": { "type": "STRING" },
                            "event": { "type": "STRING" },
                            "relevance": { "type": "STRING" }
                        },
                        required: ["year_period", "event", "relevance"]
                    }
                };

                try {
                    const data = await this.fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${this.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json", responseSchema: schema } })
                    });
                    const timelineData = JSON.parse(data.candidates[0].content.parts[0].text);

                    let timelineHtml = '<div class="timeline">';
                    timelineData.forEach((item, idx) => {
                        timelineHtml += `
                            <div class="timeline-container ${idx % 2 === 0 ? 'left' : 'right'}">
                                <div class="timeline-content">
                                    <h6>${item.year_period}</h6>
                                    <p>${item.event}</p>
                                    <small>${item.relevance}</small>
                                </div>
                            </div>
                        `;
                    });
                    timelineHtml += '</div>';
                    this.dom.genericModalBody.innerHTML = timelineHtml;

                } catch (error) {
                    this.displayError(this.dom.genericModalBody, `Error al generar la línea de tiempo: ${error.message}`);
                }
            }

            // Handles clicks on dynamically added elements using event delegation
            async handleDynamicClicks(e) {
                const target = e.target.closest('button, a');
                if (!target) return;

                if (target.classList.contains('copy-btn')) {
                    const copyTargetId = target.dataset.copyTarget;
                    let textToCopy;
                    if (copyTargetId) {
                        const targetElement = document.getElementById(copyTargetId);
                        if (targetElement) {
                            if (targetElement.tagName === 'TABLE') {
                                textToCopy = Array.from(targetElement.rows).map(row => 
                                    Array.from(row.cells).map(cell => cell.innerText.trim()).join('\t')
                                ).join('\n');
                            } else {
                                textToCopy = targetElement.innerText;
                            }
                        }
                    } else {
                        const cardContent = target.closest('.analysis-card').querySelector('.card-content');
                        textToCopy = cardContent ? cardContent.innerText : '';
                    }
                    this.copyTextToClipboard(textToCopy, target);
                } else if (target.classList.contains('cross-ref-link')) {
                    e.preventDefault();
                    const analysisIndex = target.dataset.analysisIndex;
                    const refIndex = target.dataset.refIndex;
                    this.openCrossRefModal(analysisIndex, refIndex);
                } else if (target.classList.contains('keyword-link')) {
                    e.preventDefault();
                    const word = target.dataset.word;
                    const translit = target.dataset.translit;
                    const strong = target.dataset.strong;
                    this.handleKeywordStudy(word, translit, strong);
                } else if (target.classList.contains('generate-illustrations-btn')) {
                    e.preventDefault();
                    const analysisIndex = target.dataset.analysisIndex;
                    this.handleGenerateIllustrations(analysisIndex);
                } else if (target.classList.contains('generate-dialogue-btn')) {
                    e.preventDefault();
                    const analysisIndex = target.dataset.analysisIndex;
                    const characterIndex = target.dataset.characterIndex;
                    this.handleGenerateDialogue(analysisIndex, characterIndex);
                } else if (target.classList.contains('devotional-verse-link')) {
                    e.preventDefault();
                    const reference = target.dataset.reference;
                    if (reference) {
                        this.displayVerseInModal(reference);
                    }
                } else if (target.classList.contains('generate-timeline-btn')) {
                    e.preventDefault();
                    const analysisIndex = target.dataset.analysisIndex;
                    this.handleGenerateTimeline(analysisIndex);
                } else if (target.classList.contains('btn-toggle-complete')) {
                    const card = target.closest('.reading-day-card');
                    const planId = this.dom.readingPlanSelect.value;
                    if (card && planId) {
                        this.toggleReadingDayComplete(planId, card.dataset.dayIndex);
                    }
                } else if (target.classList.contains('reading-passage-link')) {
                    e.preventDefault();
                    const passageRange = target.dataset.passage;
                    const bookName = passageRange.substring(0, passageRange.lastIndexOf(' '));
                    const chapters = passageRange.substring(passageRange.lastIndexOf(' ') + 1);
                    
                    const [start, end] = chapters.split('-').map(Number);
                    const endChapter = end || start;

                    for (let i = start; i <= endChapter; i++) {
                        const fullReference = `${bookName} ${i}:*`;
                        if (!this.passagesToStudy.includes(fullReference)) {
                            this.passagesToStudy.push(fullReference);
                        }
                    }
                    this.updatePassageList();
                    this.showAlert(`"${passageRange}" añadido a la lista de estudio. Cambiando a la pestaña de análisis.`);
                    this.dom.tabLinks[0].click();
                }
            }

            // Copies text to clipboard and provides visual feedback
            copyTextToClipboard(textToCopy, buttonElement) {
                if (!textToCopy) {
                    this.showAlert('No hay contenido para copiar.');
                    return;
                }
                try {
                    const textarea = document.createElement('textarea');
                    textarea.value = textToCopy;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);

                    const originalText = buttonElement.textContent;
                    buttonElement.textContent = '¡Copiado!';
                    buttonElement.style.backgroundColor = '#28a745';
                    setTimeout(() => {
                        buttonElement.textContent = originalText;
                        buttonElement.style.backgroundColor = '';
                    }, 2000);
                } catch (err) {
                    console.error('Error al copiar texto: ', err);
                    this.showAlert('No se pudo copiar el texto automáticamente. Por favor, copie manualmente.');
                }
            }

            // Handles tab switching
            handleTabClick(event) {
                this.dom.tabLinks.forEach(l => l.classList.remove('active'));
                this.dom.tabContents.forEach(c => c.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById(event.target.dataset.tab).classList.add('active');
            }
        }

        // Instantiate the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new BibleApp();
        });
    </script>
<script>
    async function consultarGemini(promptUsuario) {
        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: promptUsuario })
        });

        if (!response.ok) {
            throw new Error(`Error del servidor: ${response.status}`);
        }

        const data = await response.json();
        return data.result;
    }

    document.getElementById('ask-ai-btn')?.addEventListener('click', async () => {
        const input = document.getElementById('qa-input').value.trim();
        const container = document.getElementById('qa-results-container');
        container.innerHTML = '<p class="loading">Consultando a la IA...</p>';

        try {
            const respuesta = await consultarGemini(input);
            container.innerHTML = `<div class="analysis-card"><div class="card-content"><p>${respuesta}</p></div></div>`;
        } catch (err) {
            container.innerHTML = `<div class="error">Ocurrió un error: ${err.message}</div>`;
        }
    });
</script>   
</body>
</html>

